<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prebenjamín B | Calendario</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --white: #FFFFFF;
            --cream: #FAFAFA;
            --gold: #FFEA00;
            --black: #0D0D0D;
            --gray: #888;
            --gray-light: #E8E8E8;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--cream); min-height: 100vh; }
        
        /* LOGIN - MINIMALISTA */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--white);
        }
        .login-box {
            padding: 60px 40px;
            width: 100%;
            max-width: 360px;
            text-align: center;
        }
        .login-logo {
            width: 100px;
            height: 120px;
            margin: 0 auto 40px;
        }
        .login-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .login-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 0.3em;
            color: var(--black);
            margin-bottom: 40px;
            font-weight: 400;
        }
        .form-group { margin-bottom: 24px; text-align: left; }
        .form-input {
            width: 100%;
            padding: 16px 0;
            border: none;
            border-bottom: 1px solid var(--gray-light);
            font-size: 15px;
            background: transparent;
            transition: border-color 0.2s;
        }
        .form-input:focus { 
            outline: none; 
            border-bottom-color: var(--gold); 
        }
        .form-input::placeholder { color: var(--gray); }
        .login-btn {
            width: 100%;
            padding: 16px;
            background: var(--black);
            color: var(--white);
            border: none;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            letter-spacing: 0.2em;
            cursor: pointer;
            margin-top: 20px;
            transition: opacity 0.2s;
        }
        .login-btn:hover { opacity: 0.85; }
        .login-error {
            color: #c00;
            font-size: 13px;
            margin-bottom: 20px;
            display: none;
        }
        .login-error.show { display: block; }

        /* APP */
        .app { display: none; min-height: 100vh; }
        .app.active { display: block; }
        
        .header {
            background: var(--white);
            padding: 20px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--gray-light);
        }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-logo { width: 32px; height: 38px; }
        .header-logo img { width: 100%; height: 100%; object-fit: contain; }
        .header-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 0.15em;
            color: var(--black);
        }
        .header-user { display: flex; align-items: center; gap: 20px; }
        .user-name { color: var(--gray); font-size: 13px; }
        .logout-btn {
            background: transparent;
            border: none;
            color: var(--gray);
            font-size: 13px;
            cursor: pointer;
            text-decoration: underline;
        }
        .logout-btn:hover { color: var(--black); }

        .tabs {
            display: flex;
            background: var(--white);
            padding: 0 32px;
            gap: 32px;
            border-bottom: 1px solid var(--gray-light);
        }
        .tab {
            padding: 20px 0;
            background: none;
            border: none;
            font-size: 13px;
            color: var(--gray);
            cursor: pointer;
            position: relative;
            letter-spacing: 0.05em;
        }
        .tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gold);
            transform: scaleX(0);
            transition: transform 0.2s;
        }
        .tab.active { color: var(--black); }
        .tab.active::after { transform: scaleX(1); }

        .content { padding: 32px; max-width: 900px; margin: 0 auto; }
        .panel { display: none; }
        .panel.active { display: block; }

        /* CALENDAR */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }
        .month-nav { display: flex; align-items: center; gap: 24px; }
        .month-title { 
            font-family: 'Bebas Neue', sans-serif; 
            font-size: 1.6rem; 
            letter-spacing: 0.1em;
            min-width: 200px; 
            text-align: center; 
        }
        .nav-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid var(--gray-light);
            background: var(--white);
            cursor: pointer;
            font-size: 14px;
            color: var(--gray);
            transition: all 0.2s;
        }
        .nav-btn:hover { border-color: var(--black); color: var(--black); }
        .today-btn {
            padding: 10px 20px;
            background: transparent;
            color: var(--black);
            border: 1px solid var(--black);
            font-size: 12px;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .today-btn:hover { background: var(--black); color: var(--white); }

        .calendar {
            background: var(--white);
            border: 1px solid var(--gray-light);
        }
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border-bottom: 1px solid var(--gray-light);
        }
        .weekday {
            padding: 16px;
            text-align: center;
            font-size: 11px;
            font-weight: 500;
            color: var(--gray);
            letter-spacing: 0.1em;
        }
        .days { display: grid; grid-template-columns: repeat(7, 1fr); }
        .day {
            min-height: 100px;
            padding: 12px;
            border-right: 1px solid var(--gray-light);
            border-bottom: 1px solid var(--gray-light);
            cursor: pointer;
            transition: background 0.15s;
        }
        .day:nth-child(7n) { border-right: none; }
        .day:hover { background: var(--cream); }
        .day.other { background: var(--cream); }
        .day.other .day-num { color: #ccc; }
        .day.today .day-num { 
            background: var(--gold); 
            color: var(--white); 
        }
        .day-num {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 500;
            border-radius: 50%;
            margin-bottom: 6px;
        }
        .event-dot {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 10px;
            margin-top: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .event-dot.training { background: var(--gold); color: var(--white); }
        .event-dot.match { background: var(--black); color: var(--white); }
        .event-dot.meeting { background: var(--gray); color: var(--white); }

        /* EVENTS LIST */
        .events-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }
        .section-title { 
            font-family: 'Bebas Neue', sans-serif; 
            font-size: 1.3rem; 
            letter-spacing: 0.15em;
        }
        .add-btn {
            padding: 12px 24px;
            background: var(--black);
            color: var(--white);
            border: none;
            font-size: 12px;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .add-btn:hover { opacity: 0.85; }
        .event-card {
            background: var(--white);
            border: 1px solid var(--gray-light);
            padding: 24px;
            margin-bottom: 12px;
            display: flex;
            gap: 24px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .event-card:hover { border-color: var(--gold); }
        .event-date {
            text-align: center;
            min-width: 50px;
        }
        .event-date-day { 
            font-family: 'Bebas Neue', sans-serif; 
            font-size: 2rem;
            line-height: 1;
        }
        .event-date-month { 
            font-size: 10px; 
            color: var(--gray); 
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        .event-info { flex: 1; }
        .event-title { font-weight: 500; margin-bottom: 4px; font-size: 14px; }
        .event-meta { font-size: 12px; color: var(--gray); }
        .event-type {
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .event-type.training { background: rgba(212,175,55,0.15); color: var(--gold); }
        .event-type.match { background: rgba(0,0,0,0.08); color: var(--black); }

        /* IMPORT */
        .import-box {
            background: var(--white);
            border: 1px solid var(--gray-light);
            padding: 40px;
        }
        .import-description { color: var(--gray); font-size: 14px; margin: 12px 0 32px; }
        .upload-zone {
            border: 1px dashed var(--gray-light);
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .upload-zone:hover { border-color: var(--gold); }
        .upload-zone input { display: none; }
        .upload-icon { font-size: 32px; margin-bottom: 16px; opacity: 0.3; }
        .upload-text { font-size: 14px; color: var(--gray); }
        .upload-text strong { color: var(--black); }
        .preview { margin-top: 32px; display: none; }
        .preview.show { display: block; }
        .preview-title { font-size: 13px; font-weight: 500; margin-bottom: 16px; }
        .preview table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .preview th, .preview td { 
            padding: 14px 16px; 
            text-align: left; 
            border-bottom: 1px solid var(--gray-light); 
        }
        .preview th { 
            font-size: 11px; 
            text-transform: uppercase; 
            letter-spacing: 0.1em;
            color: var(--gray);
            font-weight: 500;
        }
        .import-actions { margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end; }
        .btn { 
            padding: 12px 28px; 
            font-size: 12px;
            letter-spacing: 0.1em;
            cursor: pointer; 
            border: none;
            transition: opacity 0.2s;
        }
        .btn-primary { background: var(--gold); color: var(--white); }
        .btn-secondary { background: var(--gray-light); color: var(--black); }
        .btn:hover { opacity: 0.85; }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            padding: 20px;
            transition: all 0.2s;
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal {
            background: var(--white);
            width: 100%;
            max-width: 420px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 24px 28px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title { 
            font-family: 'Bebas Neue', sans-serif; 
            font-size: 1.1rem;
            letter-spacing: 0.15em;
        }
        .modal-close {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 20px;
            color: var(--gray);
        }
        .modal-close:hover { color: var(--black); }
        .modal-body { padding: 28px; }
        .modal-body .form-group { margin-bottom: 24px; }
        .modal-body .form-label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--gray);
            margin-bottom: 10px;
        }
        .modal-footer {
            padding: 20px 28px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-select {
            width: 100%;
            padding: 14px 0;
            border: none;
            border-bottom: 1px solid var(--gray-light);
            font-size: 15px;
            background: transparent;
            cursor: pointer;
        }
        .form-select:focus { outline: none; border-bottom-color: var(--gold); }
        .btn-danger { background: transparent; color: #c00; border: 1px solid #c00; }

        /* TOAST */
        .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 2000; }
        .toast {
            background: var(--black);
            color: var(--white);
            padding: 16px 24px;
            font-size: 13px;
            margin-top: 8px;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .empty-state { text-align: center; padding: 60px; color: var(--gray); font-size: 14px; }

        /* Weekly Schedule */
        .weekly-schedule { margin-top: 24px; }
        .schedule-day {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid var(--gray-light);
        }
        .day-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            min-width: 120px;
        }
        .day-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--gold);
        }
        .day-name { font-weight: 500; }
        .day-inputs {
            display: flex;
            gap: 12px;
        }
        .time-input, .field-input {
            padding: 10px 14px;
            border: 1px solid var(--gray-light);
            font-size: 14px;
            background: var(--white);
        }
        .time-input { width: 100px; }
        .field-input { width: 120px; }
        .time-input:disabled, .field-input:disabled {
            background: var(--cream);
            color: var(--gray);
        }
        .time-input:focus, .field-input:focus {
            outline: none;
            border-color: var(--gold);
        }

        @media (max-width: 600px) {
            .content { padding: 20px; }
            .day { min-height: 70px; padding: 6px; }
            .day-num { width: 24px; height: 24px; font-size: 12px; }
            .event-dot { font-size: 9px; padding: 2px 4px; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-logo">
                <img src="https://upload.wikimedia.org/wikipedia/en/5/56/Real_Madrid_CF.svg" alt="Real Madrid">
            </div>
            <h1 class="login-title">PREBENJAMÍN B</h1>
            <div class="login-error" id="loginError">Usuario o contraseña incorrectos</div>
            <form id="loginForm">
                <div class="form-group">
                    <input type="text" class="form-input" id="username" placeholder="Usuario" required>
                </div>
                <div class="form-group">
                    <input type="password" class="form-input" id="password" placeholder="Contraseña" required>
                </div>
                <button type="submit" class="login-btn">ACCEDER</button>
            </form>
        </div>
    </div>

    <!-- APP -->
    <div class="app" id="app">
        <header class="header">
            <div class="header-left">
                <div class="header-logo">
                    <img src="https://upload.wikimedia.org/wikipedia/en/5/56/Real_Madrid_CF.svg" alt="Real Madrid">
                </div>
                <h1 class="header-title">PREBENJAMÍN B</h1>
            </div>
            <div class="header-user">
                <span class="user-name" id="userName"></span>
                <button class="logout-btn" id="logoutBtn">Cerrar sesión</button>
            </div>
        </header>

        <nav class="tabs">
            <button class="tab active" data-tab="calendar">Calendario</button>
            <button class="tab" data-tab="events">Eventos</button>
            <button class="tab" data-tab="import">Horario</button>
        </nav>

        <main class="content">
            <!-- Calendar Panel -->
            <div class="panel active" id="calendarPanel">
                <div class="calendar-header">
                    <div class="month-nav">
                        <button class="nav-btn" id="prevMonth">‹</button>
                        <h2 class="month-title" id="monthTitle"></h2>
                        <button class="nav-btn" id="nextMonth">›</button>
                    </div>
                    <button class="today-btn" id="todayBtn">HOY</button>
                </div>
                <div class="calendar">
                    <div class="weekdays">
                        <div class="weekday">LUN</div>
                        <div class="weekday">MAR</div>
                        <div class="weekday">MIÉ</div>
                        <div class="weekday">JUE</div>
                        <div class="weekday">VIE</div>
                        <div class="weekday">SÁB</div>
                        <div class="weekday">DOM</div>
                    </div>
                    <div class="days" id="calendarDays"></div>
                </div>
            </div>

            <!-- Events Panel -->
            <div class="panel" id="eventsPanel">
                <div class="events-header">
                    <h2 class="section-title">PRÓXIMOS EVENTOS</h2>
                    <button class="add-btn" id="addEventBtn">+ NUEVO</button>
                </div>
                <div id="eventsList"></div>
            </div>

            <!-- Import Panel -->
            <div class="panel" id="importPanel">
                <div class="import-box">
                    <h2 class="section-title">HORARIO SEMANAL</h2>
                    <p class="import-description">Configura los entrenamientos semanales del equipo. Se generarán automáticamente para los próximos 3 meses.</p>
                    
                    <div class="weekly-schedule" id="weeklySchedule">
                        <div class="schedule-day" data-day="1">
                            <label class="day-checkbox">
                                <input type="checkbox" class="day-check" data-day="1">
                                <span class="day-name">Lunes</span>
                            </label>
                            <div class="day-inputs">
                                <input type="time" class="time-input" data-day="1" value="18:45" disabled>
                                <input type="text" class="field-input" data-day="1" placeholder="Campo (ej: 8-B)" disabled>
                            </div>
                        </div>
                        <div class="schedule-day" data-day="2">
                            <label class="day-checkbox">
                                <input type="checkbox" class="day-check" data-day="2">
                                <span class="day-name">Martes</span>
                            </label>
                            <div class="day-inputs">
                                <input type="time" class="time-input" data-day="2" value="18:45" disabled>
                                <input type="text" class="field-input" data-day="2" placeholder="Campo (ej: 8-B)" disabled>
                            </div>
                        </div>
                        <div class="schedule-day" data-day="3">
                            <label class="day-checkbox">
                                <input type="checkbox" class="day-check" data-day="3">
                                <span class="day-name">Miércoles</span>
                            </label>
                            <div class="day-inputs">
                                <input type="time" class="time-input" data-day="3" value="18:30" disabled>
                                <input type="text" class="field-input" data-day="3" placeholder="Campo (ej: 5-B)" disabled>
                            </div>
                        </div>
                        <div class="schedule-day" data-day="4">
                            <label class="day-checkbox">
                                <input type="checkbox" class="day-check" data-day="4">
                                <span class="day-name">Jueves</span>
                            </label>
                            <div class="day-inputs">
                                <input type="time" class="time-input" data-day="4" value="18:45" disabled>
                                <input type="text" class="field-input" data-day="4" placeholder="Campo" disabled>
                            </div>
                        </div>
                        <div class="schedule-day" data-day="5">
                            <label class="day-checkbox">
                                <input type="checkbox" class="day-check" data-day="5">
                                <span class="day-name">Viernes</span>
                            </label>
                            <div class="day-inputs">
                                <input type="time" class="time-input" data-day="5" value="18:45" disabled>
                                <input type="text" class="field-input" data-day="5" placeholder="Campo" disabled>
                            </div>
                        </div>
                    </div>
                    
                    <div class="import-actions" style="margin-top: 32px;">
                        <button class="btn btn-primary" id="generateTrainings">GENERAR ENTRENAMIENTOS</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">NUEVO EVENTO</h3>
                <button class="modal-close" id="modalClose">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Título</label>
                    <input type="text" class="form-input" id="eventTitle" placeholder="Ej: Entrenamiento">
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <select class="form-select" id="eventType">
                        <option value="training">Entrenamiento</option>
                        <option value="match">Partido</option>
                        <option value="meeting">Reunión</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Fecha</label>
                        <input type="date" class="form-input" id="eventDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hora</label>
                        <input type="time" class="form-input" id="eventTime" value="17:00">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Campo / Ubicación</label>
                    <input type="text" class="form-input" id="eventLocation" placeholder="Ej: Campo 8B">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="deleteBtn" style="display:none;">ELIMINAR</button>
                <button class="btn btn-primary" id="saveBtn">GUARDAR</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toasts"></div>

    <script>
        // ===== CONFIG =====
        const SUPABASE_URL = 'https://bxawlznatchqdvpdrjuh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4YXdsem5hdGNocWR2cGRyanVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MjQ2NTgsImV4cCI6MjA4NTAwMDY1OH0.rS4_yPqMo48xwWptIDrcVxpQq_DVsImoxxPTDPTqDRU';

        const USERS = {
            'raul': { password: 'preb2026', name: 'Raúl' },
            'sergio': { password: 'preb2026', name: 'Sergio' }
        };

        // ===== STATE =====
        let currentUser = null;
        let currentDate = new Date();
        let events = [];
        let editingId = null;
        let importedData = [];

        const MONTHS = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];

        // ===== SUPABASE =====
        async function dbFetch(endpoint, method = 'GET', body = null) {
            const opts = {
                method,
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                }
            };
            if (body) opts.body = JSON.stringify(body);
            const res = await fetch(SUPABASE_URL + '/rest/v1/' + endpoint, opts);
            const text = await res.text();
            return text ? JSON.parse(text) : null;
        }

        async function loadEvents() {
            try {
                const data = await dbFetch('events?select=*&order=date.asc');
                events = data || [];
            } catch (e) {
                console.error(e);
                events = JSON.parse(localStorage.getItem('events') || '[]');
            }
        }

        async function saveEvent(event) {
            try {
                await dbFetch('events', 'POST', event);
            } catch (e) { console.error(e); }
            localStorage.setItem('events', JSON.stringify(events));
        }

        async function updateEvent(event) {
            try {
                await dbFetch('events?id=eq.' + event.id, 'PATCH', event);
            } catch (e) { console.error(e); }
            localStorage.setItem('events', JSON.stringify(events));
        }

        async function deleteEventDB(id) {
            try {
                await dbFetch('events?id=eq.' + id, 'DELETE');
            } catch (e) { console.error(e); }
            localStorage.setItem('events', JSON.stringify(events));
        }

        // ===== AUTH =====
        function login(user, pass) {
            const u = USERS[user.toLowerCase()];
            if (u && u.password === pass) {
                currentUser = user.toLowerCase();
                localStorage.setItem('user', currentUser);
                return u;
            }
            return null;
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('user');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('app').classList.remove('active');
        }

        async function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').classList.add('active');
            document.getElementById('userName').textContent = USERS[currentUser].name;
            await loadEvents();
            renderCalendar();
            renderEvents();
        }

        // ===== TOAST =====
        function toast(msg) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.textContent = msg;
            document.getElementById('toasts').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // ===== CALENDAR =====
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('monthTitle').textContent = MONTHS[month] + ' ' + year;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = (firstDay.getDay() + 6) % 7;
            const totalDays = lastDay.getDate();
            const today = new Date().toISOString().split('T')[0];

            let html = '';
            const prevMonth = new Date(year, month, 0);
            for (let i = startDay - 1; i >= 0; i--) {
                const d = prevMonth.getDate() - i;
                html += '<div class="day other"><div class="day-num">' + d + '</div></div>';
            }

            for (let d = 1; d <= totalDays; d++) {
                const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
                const isToday = dateStr === today;
                const dayEvents = events.filter(e => e.date === dateStr);
                
                html += '<div class="day' + (isToday ? ' today' : '') + '" data-date="' + dateStr + '">';
                html += '<div class="day-num">' + d + '</div>';
                dayEvents.slice(0, 2).forEach(e => {
                    html += '<div class="event-dot ' + e.type + '">' + e.title + '</div>';
                });
                if (dayEvents.length > 2) html += '<div class="event-dot" style="background:#eee;color:#666;">+' + (dayEvents.length - 2) + '</div>';
                html += '</div>';
            }

            const remaining = 42 - (startDay + totalDays);
            for (let d = 1; d <= remaining; d++) {
                html += '<div class="day other"><div class="day-num">' + d + '</div></div>';
            }

            document.getElementById('calendarDays').innerHTML = html;

            document.querySelectorAll('.day:not(.other)').forEach(day => {
                day.onclick = () => openModal(null, day.dataset.date);
            });
        }

        // ===== EVENTS LIST =====
        function renderEvents() {
            const today = new Date().toISOString().split('T')[0];
            const upcoming = events.filter(e => e.date >= today).sort((a, b) => a.date.localeCompare(b.date)).slice(0, 20);

            if (upcoming.length === 0) {
                document.getElementById('eventsList').innerHTML = '<div class="empty-state">No hay eventos próximos</div>';
                return;
            }

            let html = '';
            upcoming.forEach(e => {
                const [y, m, d] = e.date.split('-');
                const typeLabel = e.type === 'training' ? 'Entrenamiento' : e.type === 'match' ? 'Partido' : 'Reunión';
                html += '<div class="event-card" data-id="' + e.id + '">';
                html += '<div class="event-date"><div class="event-date-day">' + parseInt(d) + '</div><div class="event-date-month">' + MONTHS[parseInt(m) - 1].slice(0, 3) + '</div></div>';
                html += '<div class="event-info"><div class="event-title">' + e.title + '</div><div class="event-meta">' + e.time + (e.location ? ' · ' + e.location : '') + '</div></div>';
                html += '<span class="event-type ' + e.type + '">' + typeLabel + '</span>';
                html += '</div>';
            });

            document.getElementById('eventsList').innerHTML = html;
            document.querySelectorAll('.event-card').forEach(card => {
                card.onclick = () => openModal(card.dataset.id);
            });
        }

        // ===== MODAL =====
        function openModal(id = null, date = null) {
            editingId = id;
            const modal = document.getElementById('modal');
            
            if (id) {
                const e = events.find(x => x.id === id);
                document.getElementById('modalTitle').textContent = 'EDITAR EVENTO';
                document.getElementById('eventTitle').value = e.title;
                document.getElementById('eventType').value = e.type;
                document.getElementById('eventDate').value = e.date;
                document.getElementById('eventTime').value = e.time;
                document.getElementById('eventLocation').value = e.location || '';
                document.getElementById('deleteBtn').style.display = 'block';
            } else {
                document.getElementById('modalTitle').textContent = 'NUEVO EVENTO';
                document.getElementById('eventTitle').value = '';
                document.getElementById('eventType').value = 'training';
                document.getElementById('eventDate').value = date || new Date().toISOString().split('T')[0];
                document.getElementById('eventTime').value = '17:00';
                document.getElementById('eventLocation').value = '';
                document.getElementById('deleteBtn').style.display = 'none';
            }
            
            modal.classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
            editingId = null;
        }

        async function handleSave() {
            const title = document.getElementById('eventTitle').value.trim();
            const type = document.getElementById('eventType').value;
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const location = document.getElementById('eventLocation').value.trim();

            if (!title || !date || !time) {
                toast('Completa los campos obligatorios');
                return;
            }

            if (editingId) {
                const idx = events.findIndex(e => e.id === editingId);
                events[idx] = { ...events[idx], title, type, date, time, location };
                await updateEvent(events[idx]);
                toast('Evento actualizado');
            } else {
                const newEvent = {
                    id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                    title, type, date, time, location,
                    created_by: currentUser
                };
                events.push(newEvent);
                await saveEvent(newEvent);
                toast('Evento creado');
            }

            closeModal();
            renderCalendar();
            renderEvents();
        }

        async function handleDelete() {
            if (!editingId) return;
            if (confirm('¿Eliminar este evento?')) {
                await deleteEventDB(editingId);
                events = events.filter(e => e.id !== editingId);
                closeModal();
                renderCalendar();
                renderEvents();
                toast('Evento eliminado');
            }
        }

        // ===== WEEKLY SCHEDULE =====
        async function generateTrainings() {
            const checkboxes = document.querySelectorAll('.day-check:checked');
            
            if (checkboxes.length === 0) {
                toast('Selecciona al menos un día de entrenamiento');
                return;
            }
            
            const schedule = [];
            checkboxes.forEach(cb => {
                const day = cb.dataset.day;
                const time = document.querySelector(`.time-input[data-day="${day}"]`).value;
                const field = document.querySelector(`.field-input[data-day="${day}"]`).value.trim();
                schedule.push({ dayNum: parseInt(day), time, field });
            });
            
            const today = new Date();
            const end = new Date();
            end.setMonth(end.getMonth() + 3);

            let count = 0;
            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            
            for (const s of schedule) {
                let d = new Date(today);
                while (d <= end) {
                    if (d.getDay() === (s.dayNum % 7)) {
                        const dateStr = d.toISOString().split('T')[0];
                        if (!events.some(e => e.date === dateStr && e.type === 'training')) {
                            const newEvent = {
                                id: Date.now().toString(36) + Math.random().toString(36).substr(2) + count,
                                title: 'Entrenamiento',
                                type: 'training',
                                date: dateStr,
                                time: s.time,
                                location: s.field ? 'Campo ' + s.field : '',
                                created_by: currentUser
                            };
                            events.push(newEvent);
                            await saveEvent(newEvent);
                            count++;
                        }
                    }
                    d.setDate(d.getDate() + 1);
                }
            }

            renderCalendar();
            renderEvents();
            toast('Se añadieron ' + count + ' entrenamientos');
        }

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', function() {
            // Check session
            const savedUser = localStorage.getItem('user');
            if (savedUser && USERS[savedUser]) {
                currentUser = savedUser;
                showApp();
            }

            // Login form
            document.getElementById('loginForm').onsubmit = function(e) {
                e.preventDefault();
                const user = document.getElementById('username').value;
                const pass = document.getElementById('password').value;
                if (login(user, pass)) {
                    showApp();
                } else {
                    document.getElementById('loginError').classList.add('show');
                }
            };

            // Logout
            document.getElementById('logoutBtn').onclick = logout;

            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.onclick = function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab + 'Panel').classList.add('active');
                };
            });

            // Calendar nav
            document.getElementById('prevMonth').onclick = function() { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); };
            document.getElementById('nextMonth').onclick = function() { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); };
            document.getElementById('todayBtn').onclick = function() { currentDate = new Date(); renderCalendar(); };

            // Modal
            document.getElementById('addEventBtn').onclick = function() { openModal(); };
            document.getElementById('modalClose').onclick = closeModal;
            document.getElementById('modal').onclick = function(e) { if (e.target === this) closeModal(); };
            document.getElementById('saveBtn').onclick = handleSave;
            document.getElementById('deleteBtn').onclick = handleDelete;

            // Weekly schedule checkboxes
            document.querySelectorAll('.day-check').forEach(cb => {
                cb.onchange = function() {
                    const day = this.dataset.day;
                    const timeInput = document.querySelector(`.time-input[data-day="${day}"]`);
                    const fieldInput = document.querySelector(`.field-input[data-day="${day}"]`);
                    timeInput.disabled = !this.checked;
                    fieldInput.disabled = !this.checked;
                };
            });

            // Generate trainings button
            document.getElementById('generateTrainings').onclick = generateTrainings;
        });
    </script>
</body>
</html>
