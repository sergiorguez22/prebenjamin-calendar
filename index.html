<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prebenjam√≠n B | Calendario</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --white: #FFFFFF;
            --cream: #F5F5F0;
            --gold: #D4A853;
            --black: #1A1A1A;
            --gray: #6B6B6B;
            --gray-light: #E5E5E5;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--cream); min-height: 100vh; }
        
        /* LOGIN */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--black);
            padding: 20px;
        }
        .login-box {
            background: var(--white);
            padding: 40px;
            border-radius: 16px;
            width: 100%;
            max-width: 380px;
        }
        .login-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            text-align: center;
            margin-bottom: 30px;
            color: var(--black);
        }
        .login-title span { color: var(--gold); }
        .form-group { margin-bottom: 20px; }
        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--gray);
            margin-bottom: 8px;
        }
        .form-input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 16px;
        }
        .form-input:focus { outline: none; border-color: var(--gold); }
        .login-btn {
            width: 100%;
            padding: 14px;
            background: var(--black);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            cursor: pointer;
        }
        .login-btn:hover { background: #333; }
        .login-error {
            background: #fee;
            border: 1px solid #c00;
            color: #c00;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-size: 14px;
        }
        .login-error.show { display: block; }

        /* APP */
        .app { display: none; min-height: 100vh; }
        .app.active { display: block; }
        
        .header {
            background: var(--black);
            color: var(--white);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
        }
        .header-user { display: flex; align-items: center; gap: 16px; }
        .user-name { color: var(--gold); font-size: 14px; }
        .logout-btn {
            background: transparent;
            border: 1px solid var(--gray);
            color: var(--white);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .tabs {
            display: flex;
            background: var(--white);
            border-bottom: 1px solid var(--gray-light);
            padding: 0 24px;
        }
        .tab {
            padding: 16px 24px;
            background: none;
            border: none;
            font-size: 14px;
            color: var(--gray);
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .tab.active { color: var(--black); border-bottom-color: var(--gold); }

        .content { padding: 24px; max-width: 1000px; margin: 0 auto; }
        .panel { display: none; }
        .panel.active { display: block; }

        /* CALENDAR */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .month-nav { display: flex; align-items: center; gap: 16px; }
        .month-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; min-width: 180px; text-align: center; }
        .nav-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--gray-light);
            background: var(--white);
            cursor: pointer;
            font-size: 18px;
        }
        .nav-btn:hover { border-color: var(--gold); }
        .today-btn {
            padding: 10px 20px;
            background: var(--black);
            color: var(--white);
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .calendar {
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--black);
            color: var(--white);
        }
        .weekday {
            padding: 12px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
        }
        .days { display: grid; grid-template-columns: repeat(7, 1fr); }
        .day {
            min-height: 90px;
            padding: 8px;
            border: 1px solid var(--gray-light);
            cursor: pointer;
        }
        .day:hover { background: rgba(212,168,83,0.1); }
        .day.other { background: #f5f5f5; color: #999; }
        .day.today { background: rgba(212,168,83,0.2); }
        .day-num {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            border-radius: 50%;
        }
        .day.today .day-num { background: var(--gold); color: var(--white); }
        .event-dot {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .event-dot.training { background: var(--gold); color: var(--black); }
        .event-dot.match { background: #00529F; color: var(--white); }
        .event-dot.meeting { background: var(--black); color: var(--white); }

        /* EVENTS LIST */
        .events-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .section-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; }
        .add-btn {
            padding: 12px 24px;
            background: var(--gold);
            color: var(--black);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        .event-card {
            background: var(--white);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 12px;
            display: flex;
            gap: 20px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .event-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
        .event-date {
            text-align: center;
            padding: 8px;
            background: var(--cream);
            border-radius: 8px;
            min-width: 60px;
        }
        .event-date-day { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; }
        .event-date-month { font-size: 11px; color: var(--gray); text-transform: uppercase; }
        .event-info { flex: 1; }
        .event-title { font-weight: 600; margin-bottom: 4px; }
        .event-meta { font-size: 13px; color: var(--gray); }

        /* IMPORT */
        .import-box {
            background: var(--white);
            border-radius: 12px;
            padding: 32px;
        }
        .upload-zone {
            border: 2px dashed var(--gray-light);
            border-radius: 12px;
            padding: 48px;
            text-align: center;
            cursor: pointer;
            margin-top: 20px;
        }
        .upload-zone:hover { border-color: var(--gold); }
        .upload-zone input { display: none; }
        .upload-icon { font-size: 48px; margin-bottom: 16px; }
        .preview { margin-top: 24px; display: none; }
        .preview.show { display: block; }
        .preview table { width: 100%; border-collapse: collapse; }
        .preview th, .preview td { padding: 12px; text-align: left; border-bottom: 1px solid var(--gray-light); }
        .preview th { background: var(--cream); font-size: 12px; text-transform: uppercase; }
        .import-actions { margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end; }
        .btn { padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; }
        .btn-primary { background: var(--gold); color: var(--black); }
        .btn-secondary { background: var(--gray-light); color: var(--black); }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            padding: 20px;
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal {
            background: var(--white);
            border-radius: 12px;
            width: 100%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; }
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--cream);
            cursor: pointer;
            font-size: 18px;
        }
        .modal-body { padding: 20px; }
        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .form-select {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 16px;
            background: var(--white);
        }

        /* TOAST */
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
        .toast {
            background: var(--black);
            color: var(--white);
            padding: 16px 24px;
            border-radius: 8px;
            margin-top: 8px;
            animation: slideIn 0.3s ease;
        }
        .toast.success { border-left: 4px solid #2e7d32; }
        .toast.error { border-left: 4px solid #c62828; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .empty-state { text-align: center; padding: 48px; color: var(--gray); }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1 class="login-title">PREBENJAM√çN <span>B</span></h1>
            <div class="login-error" id="loginError">Usuario o contrase√±a incorrectos</div>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Usuario</label>
                    <input type="text" class="form-input" id="username" placeholder="Tu usuario" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" class="form-input" id="password" placeholder="Tu contrase√±a" required>
                </div>
                <button type="submit" class="login-btn">ACCEDER</button>
            </form>
        </div>
    </div>

    <!-- APP -->
    <div class="app" id="app">
        <header class="header">
            <h1 class="header-title">PREBENJAM√çN B</h1>
            <div class="header-user">
                <span class="user-name" id="userName"></span>
                <button class="logout-btn" id="logoutBtn">Cerrar sesi√≥n</button>
            </div>
        </header>

        <nav class="tabs">
            <button class="tab active" data-tab="calendar">Calendario</button>
            <button class="tab" data-tab="events">Eventos</button>
            <button class="tab" data-tab="import">Importar Excel</button>
        </nav>

        <main class="content">
            <!-- Calendar Panel -->
            <div class="panel active" id="calendarPanel">
                <div class="calendar-header">
                    <div class="month-nav">
                        <button class="nav-btn" id="prevMonth">‚Üê</button>
                        <h2 class="month-title" id="monthTitle"></h2>
                        <button class="nav-btn" id="nextMonth">‚Üí</button>
                    </div>
                    <button class="today-btn" id="todayBtn">Hoy</button>
                </div>
                <div class="calendar">
                    <div class="weekdays">
                        <div class="weekday">Lun</div>
                        <div class="weekday">Mar</div>
                        <div class="weekday">Mi√©</div>
                        <div class="weekday">Jue</div>
                        <div class="weekday">Vie</div>
                        <div class="weekday">S√°b</div>
                        <div class="weekday">Dom</div>
                    </div>
                    <div class="days" id="calendarDays"></div>
                </div>
            </div>

            <!-- Events Panel -->
            <div class="panel" id="eventsPanel">
                <div class="events-header">
                    <h2 class="section-title">PR√ìXIMOS EVENTOS</h2>
                    <button class="add-btn" id="addEventBtn">+ A√±adir evento</button>
                </div>
                <div id="eventsList"></div>
            </div>

            <!-- Import Panel -->
            <div class="panel" id="importPanel">
                <div class="import-box">
                    <h2 class="section-title">IMPORTAR HORARIO</h2>
                    <p style="color: var(--gray); margin-top: 8px;">Sube el Excel con el horario de la cantera</p>
                    <div class="upload-zone" id="uploadZone">
                        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
                        <div class="upload-icon">üìÅ</div>
                        <p><strong>Arrastra el archivo aqu√≠</strong></p>
                        <p style="color: var(--gray); font-size: 14px;">o haz clic para seleccionar</p>
                    </div>
                    <div class="preview" id="preview">
                        <h3 style="margin-bottom: 16px;">Entrenamientos detectados</h3>
                        <table>
                            <thead><tr><th>D√≠a</th><th>Hora</th><th>Campo</th></tr></thead>
                            <tbody id="previewBody"></tbody>
                        </table>
                        <div class="import-actions">
                            <button class="btn btn-secondary" id="cancelImport">Cancelar</button>
                            <button class="btn btn-primary" id="confirmImport">Importar</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">NUEVO EVENTO</h3>
                <button class="modal-close" id="modalClose">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">T√≠tulo</label>
                    <input type="text" class="form-input" id="eventTitle" placeholder="Ej: Entrenamiento">
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <select class="form-select" id="eventType">
                        <option value="training">Entrenamiento</option>
                        <option value="match">Partido</option>
                        <option value="meeting">Reuni√≥n</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Fecha</label>
                        <input type="date" class="form-input" id="eventDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hora</label>
                        <input type="time" class="form-input" id="eventTime" value="17:00">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Campo / Ubicaci√≥n</label>
                    <input type="text" class="form-input" id="eventLocation" placeholder="Ej: Campo 8B">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="deleteBtn" style="display:none;">Eliminar</button>
                <button class="btn btn-primary" id="saveBtn">Guardar</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toasts"></div>

    <script>
        // ===== CONFIG =====
        const SUPABASE_URL = 'https://bxawlznatchqdvpdrjuh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4YXdsem5hdGNocWR2cGRyanVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MjQ2NTgsImV4cCI6MjA4NTAwMDY1OH0.rS4_yPqMo48xwWptIDrcVxpQq_DVsImoxxPTDPTqDRU';

        const USERS = {
            'raul': { password: 'preb2026', name: 'Raul' },
            'sergio': { password: 'preb2026', name: 'Sergio' }
        };

        // ===== STATE =====
        let currentUser = null;
        let currentDate = new Date();
        let events = [];
        let editingId = null;
        let importedData = [];

        const MONTHS = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];

        // ===== SUPABASE =====
        async function dbFetch(endpoint, method = 'GET', body = null) {
            const opts = {
                method,
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                }
            };
            if (body) opts.body = JSON.stringify(body);
            const res = await fetch(SUPABASE_URL + '/rest/v1/' + endpoint, opts);
            const text = await res.text();
            return text ? JSON.parse(text) : null;
        }

        async function loadEvents() {
            try {
                const data = await dbFetch('events?select=*&order=date.asc');
                events = data || [];
            } catch (e) {
                console.error(e);
                events = JSON.parse(localStorage.getItem('events') || '[]');
            }
        }

        async function saveEvent(event) {
            try {
                await dbFetch('events', 'POST', event);
            } catch (e) { console.error(e); }
            localStorage.setItem('events', JSON.stringify(events));
        }

        async function updateEvent(event) {
            try {
                await dbFetch('events?id=eq.' + event.id, 'PATCH', event);
            } catch (e) { console.error(e); }
            localStorage.setItem('events', JSON.stringify(events));
        }

        async function deleteEvent(id) {
            try {
                await dbFetch('events?id=eq.' + id, 'DELETE');
            } catch (e) { console.error(e); }
            localStorage.setItem('events', JSON.stringify(events));
        }

        // ===== AUTH =====
        function login(user, pass) {
            const u = USERS[user.toLowerCase()];
            if (u && u.password === pass) {
                currentUser = user.toLowerCase();
                localStorage.setItem('user', currentUser);
                return u;
            }
            return null;
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('user');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('app').classList.remove('active');
        }

        async function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').classList.add('active');
            document.getElementById('userName').textContent = USERS[currentUser].name;
            await loadEvents();
            renderCalendar();
            renderEvents();
        }

        // ===== TOAST =====
        function toast(msg, type = 'success') {
            const t = document.createElement('div');
            t.className = 'toast ' + type;
            t.textContent = msg;
            document.getElementById('toasts').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // ===== CALENDAR =====
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('monthTitle').textContent = MONTHS[month] + ' ' + year;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = (firstDay.getDay() + 6) % 7;
            const totalDays = lastDay.getDate();
            const today = new Date().toISOString().split('T')[0];

            let html = '';
            const prevMonth = new Date(year, month, 0);
            for (let i = startDay - 1; i >= 0; i--) {
                const d = prevMonth.getDate() - i;
                html += '<div class="day other"><div class="day-num">' + d + '</div></div>';
            }

            for (let d = 1; d <= totalDays; d++) {
                const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
                const isToday = dateStr === today;
                const dayEvents = events.filter(e => e.date === dateStr);
                
                html += '<div class="day' + (isToday ? ' today' : '') + '" data-date="' + dateStr + '">';
                html += '<div class="day-num">' + d + '</div>';
                dayEvents.slice(0, 2).forEach(e => {
                    html += '<div class="event-dot ' + e.type + '">' + e.title + '</div>';
                });
                if (dayEvents.length > 2) html += '<div class="event-dot" style="background:#ddd;">+' + (dayEvents.length - 2) + '</div>';
                html += '</div>';
            }

            const remaining = 42 - (startDay + totalDays);
            for (let d = 1; d <= remaining; d++) {
                html += '<div class="day other"><div class="day-num">' + d + '</div></div>';
            }

            document.getElementById('calendarDays').innerHTML = html;

            document.querySelectorAll('.day:not(.other)').forEach(day => {
                day.onclick = () => openModal(null, day.dataset.date);
            });
        }

        // ===== EVENTS LIST =====
        function renderEvents() {
            const today = new Date().toISOString().split('T')[0];
            const upcoming = events.filter(e => e.date >= today).sort((a, b) => a.date.localeCompare(b.date)).slice(0, 20);

            if (upcoming.length === 0) {
                document.getElementById('eventsList').innerHTML = '<div class="empty-state">No hay eventos pr√≥ximos</div>';
                return;
            }

            let html = '';
            upcoming.forEach(e => {
                const [y, m, d] = e.date.split('-');
                html += '<div class="event-card" data-id="' + e.id + '">';
                html += '<div class="event-date"><div class="event-date-day">' + parseInt(d) + '</div><div class="event-date-month">' + MONTHS[parseInt(m) - 1].slice(0, 3) + '</div></div>';
                html += '<div class="event-info"><div class="event-title">' + e.title + '</div><div class="event-meta">' + e.time + (e.location ? ' ¬∑ ' + e.location : '') + '</div></div>';
                html += '</div>';
            });

            document.getElementById('eventsList').innerHTML = html;
            document.querySelectorAll('.event-card').forEach(card => {
                card.onclick = () => openModal(card.dataset.id);
            });
        }

        // ===== MODAL =====
        function openModal(id = null, date = null) {
            editingId = id;
            const modal = document.getElementById('modal');
            
            if (id) {
                const e = events.find(x => x.id === id);
                document.getElementById('modalTitle').textContent = 'EDITAR EVENTO';
                document.getElementById('eventTitle').value = e.title;
                document.getElementById('eventType').value = e.type;
                document.getElementById('eventDate').value = e.date;
                document.getElementById('eventTime').value = e.time;
                document.getElementById('eventLocation').value = e.location || '';
                document.getElementById('deleteBtn').style.display = 'block';
            } else {
                document.getElementById('modalTitle').textContent = 'NUEVO EVENTO';
                document.getElementById('eventTitle').value = '';
                document.getElementById('eventType').value = 'training';
                document.getElementById('eventDate').value = date || new Date().toISOString().split('T')[0];
                document.getElementById('eventTime').value = '17:00';
                document.getElementById('eventLocation').value = '';
                document.getElementById('deleteBtn').style.display = 'none';
            }
            
            modal.classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
            editingId = null;
        }

        async function handleSave() {
            const title = document.getElementById('eventTitle').value.trim();
            const type = document.getElementById('eventType').value;
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const location = document.getElementById('eventLocation').value.trim();

            if (!title || !date || !time) {
                toast('Completa los campos obligatorios', 'error');
                return;
            }

            if (editingId) {
                const idx = events.findIndex(e => e.id === editingId);
                events[idx] = { ...events[idx], title, type, date, time, location };
                await updateEvent(events[idx]);
                toast('Evento actualizado');
            } else {
                const newEvent = {
                    id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                    title, type, date, time, location,
                    created_by: currentUser
                };
                events.push(newEvent);
                await saveEvent(newEvent);
                toast('Evento creado');
            }

            closeModal();
            renderCalendar();
            renderEvents();
        }

        async function handleDelete() {
            if (!editingId) return;
            if (confirm('¬øEliminar este evento?')) {
                await deleteEvent(editingId);
                events = events.filter(e => e.id !== editingId);
                closeModal();
                renderCalendar();
                renderEvents();
                toast('Evento eliminado');
            }
        }

        // ===== EXCEL IMPORT =====
        function processFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    
                    let trainings = [];
                    const dayMap = { 'lunes': 1, 'martes': 2, 'miercoles': 3, 'mi√©rcoles': 3, 'jueves': 4, 'viernes': 5, 'sabado': 6, 's√°bado': 6, 'domingo': 0 };

                    wb.SheetNames.forEach(name => {
                        const sheet = XLSX.utils.sheet_to_json(wb.Sheets[name], { header: 1 });
                        let found = false;
                        
                        sheet.forEach((row, ri) => {
                            const rowStr = row.join(' ').toLowerCase();
                            if (rowStr.includes('prebenjamin b') || rowStr.includes('prebenjam√≠n b')) found = true;
                            
                            if (found && ri < sheet.length) {
                                Object.keys(dayMap).forEach(day => {
                                    if (rowStr.includes(day)) {
                                        let time = '17:00', field = '';
                                        row.forEach(cell => {
                                            if (cell) {
                                                const s = String(cell);
                                                const tm = s.match(/(\d{1,2}):(\d{2})/);
                                                if (tm) time = tm[0];
                                                const fm = s.match(/campo?\s*(\d+[a-z]?)/i);
                                                if (fm) field = fm[1];
                                            }
                                        });
                                        trainings.push({ day: day.charAt(0).toUpperCase() + day.slice(1), dayNum: dayMap[day], time, field });
                                    }
                                });
                            }
                        });
                    });

                    trainings = trainings.filter((t, i, a) => a.findIndex(x => x.dayNum === t.dayNum) === i);
                    
                    if (trainings.length === 0) {
                        toast('No se encontr√≥ informaci√≥n del Prebenjam√≠n B', 'error');
                        return;
                    }

                    importedData = trainings;
                    let html = '';
                    trainings.forEach(t => {
                        html += '<tr><td>' + t.day + '</td><td>' + t.time + '</td><td>' + (t.field || '-') + '</td></tr>';
                    });
                    document.getElementById('previewBody').innerHTML = html;
                    document.getElementById('preview').classList.add('show');

                } catch (err) {
                    console.error(err);
                    toast('Error al procesar el archivo', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function confirmImport() {
            const today = new Date();
            const end = new Date();
            end.setMonth(end.getMonth() + 3);

            let count = 0;
            for (const t of importedData) {
                let d = new Date(today);
                while (d <= end) {
                    if (d.getDay() === t.dayNum) {
                        const dateStr = d.toISOString().split('T')[0];
                        if (!events.some(e => e.date === dateStr && e.type === 'training' && e.time === t.time)) {
                            const newEvent = {
                                id: Date.now().toString(36) + Math.random().toString(36).substr(2) + count,
                                title: 'Entrenamiento',
                                type: 'training',
                                date: dateStr,
                                time: t.time,
                                location: t.field ? 'Campo ' + t.field : '',
                                created_by: currentUser
                            };
                            events.push(newEvent);
                            await saveEvent(newEvent);
                            count++;
                        }
                    }
                    d.setDate(d.getDate() + 1);
                }
            }

            document.getElementById('preview').classList.remove('show');
            document.getElementById('fileInput').value = '';
            importedData = [];
            renderCalendar();
            renderEvents();
            toast('Se a√±adieron ' + count + ' entrenamientos');
        }

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', function() {
            // Check session
            const savedUser = localStorage.getItem('user');
            if (savedUser && USERS[savedUser]) {
                currentUser = savedUser;
                showApp();
            }

            // Login form
            document.getElementById('loginForm').onsubmit = function(e) {
                e.preventDefault();
                const user = document.getElementById('username').value;
                const pass = document.getElementById('password').value;
                if (login(user, pass)) {
                    showApp();
                } else {
                    document.getElementById('loginError').classList.add('show');
                }
            };

            // Logout
            document.getElementById('logoutBtn').onclick = logout;

            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.onclick = function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab + 'Panel').classList.add('active');
                };
            });

            // Calendar nav
            document.getElementById('prevMonth').onclick = function() { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); };
            document.getElementById('nextMonth').onclick = function() { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); };
            document.getElementById('todayBtn').onclick = function() { currentDate = new Date(); renderCalendar(); };

            // Modal
            document.getElementById('addEventBtn').onclick = function() { openModal(); };
            document.getElementById('modalClose').onclick = closeModal;
            document.getElementById('modal').onclick = function(e) { if (e.target === this) closeModal(); };
            document.getElementById('saveBtn').onclick = handleSave;
            document.getElementById('deleteBtn').onclick = handleDelete;

            // File upload
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');
            uploadZone.onclick = function() { fileInput.click(); };
            fileInput.onchange = function() { if (this.files[0]) processFile(this.files[0]); };
            uploadZone.ondragover = function(e) { e.preventDefault(); this.style.borderColor = '#D4A853'; };
            uploadZone.ondragleave = function() { this.style.borderColor = '#E5E5E5'; };
            uploadZone.ondrop = function(e) { e.preventDefault(); this.style.borderColor = '#E5E5E5'; if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]); };

            document.getElementById('cancelImport').onclick = function() { document.getElementById('preview').classList.remove('show'); importedData = []; };
            document.getElementById('confirmImport').onclick = confirmImport;
        });
    </script>
</body>
</html>
