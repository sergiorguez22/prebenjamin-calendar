<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prebenjam√≠n B | Calendario</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            --white: #FFFFFF;
            --cream: #FAFAFA;
            --gold: #D4AF37;
            --black: #0D0D0D;
            --gray: #888;
            --gray-light: #E8E8E8;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--cream); min-height: 100vh; }
        
        /* LOGIN - MINIMALISTA */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--white);
        }
        .login-box {
            padding: 60px 40px;
            width: 100%;
            max-width: 360px;
            text-align: center;
        }
        .login-logo {
            width: 100px;
            height: 120px;
            margin: 0 auto 40px;
        }
        .login-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .login-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 0.3em;
            color: var(--black);
            margin-bottom: 40px;
            font-weight: 400;
        }
        .form-group { margin-bottom: 24px; text-align: left; }
        .form-input {
            width: 100%;
            padding: 16px 0;
            border: none;
            border-bottom: 1px solid var(--gray-light);
            font-size: 15px;
            background: transparent;
            transition: border-color 0.2s;
        }
        .form-input:focus { 
            outline: none; 
            border-bottom-color: var(--gold); 
        }
        .form-input::placeholder { color: var(--gray); }
        .login-btn {
            width: 100%;
            padding: 16px;
            background: var(--black);
            color: var(--white);
            border: none;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            letter-spacing: 0.2em;
            cursor: pointer;
            margin-top: 20px;
            transition: opacity 0.2s;
        }
        .login-btn:hover { opacity: 0.85; }
        .login-error {
            color: #c00;
            font-size: 13px;
            margin-bottom: 20px;
            display: none;
        }
        .login-error.show { display: block; }

        /* APP */
        .app { display: none; min-height: 100vh; }
        .app.active { display: block; }
        
        .header {
            background: var(--white);
            padding: 20px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--gray-light);
        }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-logo { width: 32px; height: 38px; }
        .header-logo img { width: 100%; height: 100%; object-fit: contain; }
        .header-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 0.15em;
            color: var(--black);
        }
        .header-user { display: flex; align-items: center; gap: 20px; }
        .user-name { color: var(--gray); font-size: 13px; }
        .logout-btn {
            background: transparent;
            border: none;
            color: var(--gray);
            font-size: 13px;
            cursor: pointer;
            text-decoration: underline;
        }
        .logout-btn:hover { color: var(--black); }

        .tabs {
            display: flex;
            background: var(--white);
            padding: 0 32px;
            gap: 32px;
            border-bottom: 1px solid var(--gray-light);
        }
        .tab {
            padding: 20px 0;
            background: none;
            border: none;
            font-size: 13px;
            color: var(--gray);
            cursor: pointer;
            position: relative;
            letter-spacing: 0.05em;
        }
        .tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gold);
            transform: scaleX(0);
            transition: transform 0.2s;
        }
        .tab.active { color: var(--black); }
        .tab.active::after { transform: scaleX(1); }

        .content { padding: 32px; max-width: 900px; margin: 0 auto; }
        .panel { display: none; }
        .panel.active { display: block; }

        /* CALENDAR */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }
        .month-nav { display: flex; align-items: center; gap: 24px; }
        .month-title { 
            font-family: 'Bebas Neue', sans-serif; 
            font-size: 1.6rem; 
            letter-spacing: 0.1em;
            min-width: 200px; 
            text-align: center; 
        }
        .nav-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid var(--gray-light);
            background: var(--white);
            cursor: pointer;
            font-size: 14px;
            color: var(--gray);
            transition: all 0.2s;
        }
        .nav-btn:hover { border-color: var(--black); color: var(--black); }
        .today-btn {
            padding: 10px 20px;
            background: transparent;
            color: var(--black);
            border: 1px solid var(--black);
            font-size: 12px;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .today-btn:hover { background: var(--black); color: var(--white); }

        .calendar {
            background: var(--white);
            border: 1px solid var(--gray-light);
        }
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border-bottom: 1px solid var(--gray-light);
        }
        .weekday {
            padding: 16px;
            text-align: center;
            font-size: 11px;
            font-weight: 500;
            color: var(--gray);
            letter-spacing: 0.1em;
        }
        .days { display: grid; grid-template-columns: repeat(7, 1fr); }
        .day {
            min-height: 100px;
            padding: 12px;
            border-right: 1px solid var(--gray-light);
            border-bottom: 1px solid var(--gray-light);
            cursor: pointer;
            transition: background 0.15s;
        }
        .day:nth-child(7n) { border-right: none; }
        .day:hover { background: var(--cream); }
        .day.other { background: var(--cream); }
        .day.other .day-num { color: #ccc; }
        .day.today .day-num { 
            background: var(--gold); 
            color: var(--white); 
        }
        .day-num {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 500;
            border-radius: 50%;
            margin-bottom: 6px;
        }
        .event-dot {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 10px;
            margin-top: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .event-dot.training { background: var(--gold); color: var(--white); }
        .event-dot.match { background: var(--black); color: var(--white); }
        .event-dot.meeting { background: var(--gray); color: var(--white); }

        /* EVENTS LIST */
        .events-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }
        .section-title { 
            font-family: 'Bebas Neue', sans-serif; 
            font-size: 1.3rem; 
            letter-spacing: 0.15em;
        }
        .add-btn {
            padding: 12px 24px;
            background: var(--black);
            color: var(--white);
            border: none;
            font-size: 12px;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .add-btn:hover { opacity: 0.85; }
        .event-card {
            background: var(--white);
            border: 1px solid var(--gray-light);
            padding: 24px;
            margin-bottom: 12px;
            display: flex;
            gap: 24px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .event-card:hover { border-color: var(--gold); }
        .event-date {
            text-align: center;
            min-width: 50px;
        }
        .event-date-day { 
            font-family: 'Bebas Neue', sans-serif; 
            font-size: 2rem;
            line-height: 1;
        }
        .event-date-month { 
            font-size: 10px; 
            color: var(--gray); 
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        .event-info { flex: 1; }
        .event-title { font-weight: 500; margin-bottom: 4px; font-size: 14px; }
        .event-meta { font-size: 12px; color: var(--gray); }
        .event-type {
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .event-type.training { background: rgba(212,175,55,0.15); color: var(--gold); }
        .event-type.match { background: rgba(0,0,0,0.08); color: var(--black); }

        /* IMPORT */
        .import-box {
            background: var(--white);
            border: 1px solid var(--gray-light);
            padding: 40px;
        }
        .import-description { color: var(--gray); font-size: 14px; margin: 12px 0 32px; }
        .upload-zone {
            border: 1px dashed var(--gray-light);
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .upload-zone:hover { border-color: var(--gold); }
        .upload-zone input { display: none; }
        .upload-icon { font-size: 32px; margin-bottom: 16px; opacity: 0.3; }
        .upload-text { font-size: 14px; color: var(--gray); }
        .upload-text strong { color: var(--black); }
        .preview { margin-top: 32px; display: none; }
        .preview.show { display: block; }
        .preview-title { font-size: 13px; font-weight: 500; margin-bottom: 16px; }
        .preview table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .preview th, .preview td { 
            padding: 14px 16px; 
            text-align: left; 
            border-bottom: 1px solid var(--gray-light); 
        }
        .preview th { 
            font-size: 11px; 
            text-transform: uppercase; 
            letter-spacing: 0.1em;
            color: var(--gray);
            font-weight: 500;
        }
        .import-actions { margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end; }
        .btn { 
            padding: 12px 28px; 
            font-size: 12px;
            letter-spacing: 0.1em;
            cursor: pointer; 
            border: none;
            transition: opacity 0.2s;
        }
        .btn-primary { background: var(--gold); color: var(--white); }
        .btn-secondary { background: var(--gray-light); color: var(--black); }
        .btn:hover { opacity: 0.85; }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            padding: 20px;
            transition: all 0.2s;
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal {
            background: var(--white);
            width: 100%;
            max-width: 420px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 24px 28px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title { 
            font-family: 'Bebas Neue', sans-serif; 
            font-size: 1.1rem;
            letter-spacing: 0.15em;
        }
        .modal-close {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 20px;
            color: var(--gray);
        }
        .modal-close:hover { color: var(--black); }
        .modal-body { padding: 28px; }
        .modal-body .form-group { margin-bottom: 24px; }
        .modal-body .form-label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--gray);
            margin-bottom: 10px;
        }
        .modal-footer {
            padding: 20px 28px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-select {
            width: 100%;
            padding: 14px 0;
            border: none;
            border-bottom: 1px solid var(--gray-light);
            font-size: 15px;
            background: transparent;
            cursor: pointer;
        }
        .form-select:focus { outline: none; border-bottom-color: var(--gold); }
        .btn-danger { background: transparent; color: #c00; border: 1px solid #c00; }

        /* TOAST */
        .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 2000; }
        .toast {
            background: var(--black);
            color: var(--white);
            padding: 16px 24px;
            font-size: 13px;
            margin-top: 8px;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .empty-state { text-align: center; padding: 60px; color: var(--gray); font-size: 14px; }

        @media (max-width: 600px) {
            .content { padding: 20px; }
            .day { min-height: 70px; padding: 6px; }
            .day-num { width: 24px; height: 24px; font-size: 12px; }
            .event-dot { font-size: 9px; padding: 2px 4px; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-logo">
                <img src="https://upload.wikimedia.org/wikipedia/en/5/56/Real_Madrid_CF.svg" alt="Real Madrid">
            </div>
            <h1 class="login-title">PREBENJAM√çN B</h1>
            <div class="login-error" id="loginError">Usuario o contrase√±a incorrectos</div>
            <form id="loginForm">
                <div class="form-group">
                    <input type="text" class="form-input" id="username" placeholder="Usuario" required>
                </div>
                <div class="form-group">
                    <input type="password" class="form-input" id="password" placeholder="Contrase√±a" required>
                </div>
                <button type="submit" class="login-btn">ACCEDER</button>
            </form>
        </div>
    </div>

    <!-- APP -->
    <div class="app" id="app">
        <header class="header">
            <div class="header-left">
                <div class="header-logo">
                    <img src="https://upload.wikimedia.org/wikipedia/en/5/56/Real_Madrid_CF.svg" alt="Real Madrid">
                </div>
                <h1 class="header-title">PREBENJAM√çN B</h1>
            </div>
            <div class="header-user">
                <span class="user-name" id="userName"></span>
                <button class="logout-btn" id="logoutBtn">Cerrar sesi√≥n</button>
            </div>
        </header>

        <nav class="tabs">
            <button class="tab active" data-tab="calendar">Calendario</button>
            <button class="tab" data-tab="events">Eventos</button>
            <button class="tab" data-tab="import">Importar PDF</button>
        </nav>

        <main class="content">
            <!-- Calendar Panel -->
            <div class="panel active" id="calendarPanel">
                <div class="calendar-header">
                    <div class="month-nav">
                        <button class="nav-btn" id="prevMonth">‚Äπ</button>
                        <h2 class="month-title" id="monthTitle"></h2>
                        <button class="nav-btn" id="nextMonth">‚Ä∫</button>
                    </div>
                    <button class="today-btn" id="todayBtn">HOY</button>
                </div>
                <div class="calendar">
                    <div class="weekdays">
                        <div class="weekday">LUN</div>
                        <div class="weekday">MAR</div>
                        <div class="weekday">MI√â</div>
                        <div class="weekday">JUE</div>
                        <div class="weekday">VIE</div>
                        <div class="weekday">S√ÅB</div>
                        <div class="weekday">DOM</div>
                    </div>
                    <div class="days" id="calendarDays"></div>
                </div>
            </div>

            <!-- Events Panel -->
            <div class="panel" id="eventsPanel">
                <div class="events-header">
                    <h2 class="section-title">PR√ìXIMOS EVENTOS</h2>
                    <button class="add-btn" id="addEventBtn">+ NUEVO</button>
                </div>
                <div id="eventsList"></div>
            </div>

            <!-- Import Panel -->
            <div class="panel" id="importPanel">
                <div class="import-box">
                    <h2 class="section-title">IMPORTAR HORARIO</h2>
                    <p class="import-description">Sube el PDF con el horario de la cantera. Se detectar√°n autom√°ticamente los entrenamientos del Prebenjam√≠n B.</p>
                    <div class="upload-zone" id="uploadZone">
                        <input type="file" id="fileInput" accept=".pdf">
                        <div class="upload-icon">üìÑ</div>
                        <p class="upload-text"><strong>Arrastra el PDF aqu√≠</strong><br>o haz clic para seleccionar</p>
                    </div>
                    <div class="preview" id="preview">
                        <div class="preview-title">Entrenamientos detectados</div>
                        <table>
                            <thead><tr><th>D√≠a</th><th>Hora</th><th>Campo</th></tr></thead>
                            <tbody id="previewBody"></tbody>
                        </table>
                        <div class="import-actions">
                            <button class="btn btn-secondary" id="cancelImport">CANCELAR</button>
                            <button class="btn btn-primary" id="confirmImport">IMPORTAR</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">NUEVO EVENTO</h3>
                <button class="modal-close" id="modalClose">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">T√≠tulo</label>
                    <input type="text" class="form-input" id="eventTitle" placeholder="Ej: Entrenamiento">
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <select class="form-select" id="eventType">
                        <option value="training">Entrenamiento</option>
                        <option value="match">Partido</option>
                        <option value="meeting">Reuni√≥n</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Fecha</label>
                        <input type="date" class="form-input" id="eventDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hora</label>
                        <input type="time" class="form-input" id="eventTime" value="17:00">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Campo / Ubicaci√≥n</label>
                    <input type="text" class="form-input" id="eventLocation" placeholder="Ej: Campo 8B">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="deleteBtn" style="display:none;">ELIMINAR</button>
                <button class="btn btn-primary" id="saveBtn">GUARDAR</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toasts"></div>

    <script>
        // ===== CONFIG =====
        const SUPABASE_URL = 'https://bxawlznatchqdvpdrjuh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4YXdsem5hdGNocWR2cGRyanVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MjQ2NTgsImV4cCI6MjA4NTAwMDY1OH0.rS4_yPqMo48xwWptIDrcVxpQq_DVsImoxxPTDPTqDRU';

        const USERS = {
            'raul': { password: 'preb2026', name: 'Ra√∫l' },
            'sergio': { password: 'preb2026', name: 'Sergio' }
        };

        // ===== STATE =====
        let currentUser = null;
        let currentDate = new Date();
        let events = [];
        let editingId = null;
        let importedData = [];

        const MONTHS = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];

        // PDF.js config
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // ===== SUPABASE =====
        async function dbFetch(endpoint, method = 'GET', body = null) {
            const opts = {
                method,
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                }
            };
            if (body) opts.body = JSON.stringify(body);
            const res = await fetch(SUPABASE_URL + '/rest/v1/' + endpoint, opts);
            const text = await res.text();
            return text ? JSON.parse(text) : null;
        }

        async function loadEvents() {
            try {
                const data = await dbFetch('events?select=*&order=date.asc');
                events = data || [];
            } catch (e) {
                console.error(e);
                events = JSON.parse(localStorage.getItem('events') || '[]');
            }
        }

        async function saveEvent(event) {
            try {
                await dbFetch('events', 'POST', event);
            } catch (e) { console.error(e); }
            localStorage.setItem('events', JSON.stringify(events));
        }

        async function updateEvent(event) {
            try {
                await dbFetch('events?id=eq.' + event.id, 'PATCH', event);
            } catch (e) { console.error(e); }
            localStorage.setItem('events', JSON.stringify(events));
        }

        async function deleteEventDB(id) {
            try {
                await dbFetch('events?id=eq.' + id, 'DELETE');
            } catch (e) { console.error(e); }
            localStorage.setItem('events', JSON.stringify(events));
        }

        // ===== AUTH =====
        function login(user, pass) {
            const u = USERS[user.toLowerCase()];
            if (u && u.password === pass) {
                currentUser = user.toLowerCase();
                localStorage.setItem('user', currentUser);
                return u;
            }
            return null;
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('user');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('app').classList.remove('active');
        }

        async function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').classList.add('active');
            document.getElementById('userName').textContent = USERS[currentUser].name;
            await loadEvents();
            renderCalendar();
            renderEvents();
        }

        // ===== TOAST =====
        function toast(msg) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.textContent = msg;
            document.getElementById('toasts').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // ===== CALENDAR =====
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('monthTitle').textContent = MONTHS[month] + ' ' + year;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = (firstDay.getDay() + 6) % 7;
            const totalDays = lastDay.getDate();
            const today = new Date().toISOString().split('T')[0];

            let html = '';
            const prevMonth = new Date(year, month, 0);
            for (let i = startDay - 1; i >= 0; i--) {
                const d = prevMonth.getDate() - i;
                html += '<div class="day other"><div class="day-num">' + d + '</div></div>';
            }

            for (let d = 1; d <= totalDays; d++) {
                const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
                const isToday = dateStr === today;
                const dayEvents = events.filter(e => e.date === dateStr);
                
                html += '<div class="day' + (isToday ? ' today' : '') + '" data-date="' + dateStr + '">';
                html += '<div class="day-num">' + d + '</div>';
                dayEvents.slice(0, 2).forEach(e => {
                    html += '<div class="event-dot ' + e.type + '">' + e.title + '</div>';
                });
                if (dayEvents.length > 2) html += '<div class="event-dot" style="background:#eee;color:#666;">+' + (dayEvents.length - 2) + '</div>';
                html += '</div>';
            }

            const remaining = 42 - (startDay + totalDays);
            for (let d = 1; d <= remaining; d++) {
                html += '<div class="day other"><div class="day-num">' + d + '</div></div>';
            }

            document.getElementById('calendarDays').innerHTML = html;

            document.querySelectorAll('.day:not(.other)').forEach(day => {
                day.onclick = () => openModal(null, day.dataset.date);
            });
        }

        // ===== EVENTS LIST =====
        function renderEvents() {
            const today = new Date().toISOString().split('T')[0];
            const upcoming = events.filter(e => e.date >= today).sort((a, b) => a.date.localeCompare(b.date)).slice(0, 20);

            if (upcoming.length === 0) {
                document.getElementById('eventsList').innerHTML = '<div class="empty-state">No hay eventos pr√≥ximos</div>';
                return;
            }

            let html = '';
            upcoming.forEach(e => {
                const [y, m, d] = e.date.split('-');
                const typeLabel = e.type === 'training' ? 'Entrenamiento' : e.type === 'match' ? 'Partido' : 'Reuni√≥n';
                html += '<div class="event-card" data-id="' + e.id + '">';
                html += '<div class="event-date"><div class="event-date-day">' + parseInt(d) + '</div><div class="event-date-month">' + MONTHS[parseInt(m) - 1].slice(0, 3) + '</div></div>';
                html += '<div class="event-info"><div class="event-title">' + e.title + '</div><div class="event-meta">' + e.time + (e.location ? ' ¬∑ ' + e.location : '') + '</div></div>';
                html += '<span class="event-type ' + e.type + '">' + typeLabel + '</span>';
                html += '</div>';
            });

            document.getElementById('eventsList').innerHTML = html;
            document.querySelectorAll('.event-card').forEach(card => {
                card.onclick = () => openModal(card.dataset.id);
            });
        }

        // ===== MODAL =====
        function openModal(id = null, date = null) {
            editingId = id;
            const modal = document.getElementById('modal');
            
            if (id) {
                const e = events.find(x => x.id === id);
                document.getElementById('modalTitle').textContent = 'EDITAR EVENTO';
                document.getElementById('eventTitle').value = e.title;
                document.getElementById('eventType').value = e.type;
                document.getElementById('eventDate').value = e.date;
                document.getElementById('eventTime').value = e.time;
                document.getElementById('eventLocation').value = e.location || '';
                document.getElementById('deleteBtn').style.display = 'block';
            } else {
                document.getElementById('modalTitle').textContent = 'NUEVO EVENTO';
                document.getElementById('eventTitle').value = '';
                document.getElementById('eventType').value = 'training';
                document.getElementById('eventDate').value = date || new Date().toISOString().split('T')[0];
                document.getElementById('eventTime').value = '17:00';
                document.getElementById('eventLocation').value = '';
                document.getElementById('deleteBtn').style.display = 'none';
            }
            
            modal.classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
            editingId = null;
        }

        async function handleSave() {
            const title = document.getElementById('eventTitle').value.trim();
            const type = document.getElementById('eventType').value;
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const location = document.getElementById('eventLocation').value.trim();

            if (!title || !date || !time) {
                toast('Completa los campos obligatorios');
                return;
            }

            if (editingId) {
                const idx = events.findIndex(e => e.id === editingId);
                events[idx] = { ...events[idx], title, type, date, time, location };
                await updateEvent(events[idx]);
                toast('Evento actualizado');
            } else {
                const newEvent = {
                    id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                    title, type, date, time, location,
                    created_by: currentUser
                };
                events.push(newEvent);
                await saveEvent(newEvent);
                toast('Evento creado');
            }

            closeModal();
            renderCalendar();
            renderEvents();
        }

        async function handleDelete() {
            if (!editingId) return;
            if (confirm('¬øEliminar este evento?')) {
                await deleteEventDB(editingId);
                events = events.filter(e => e.id !== editingId);
                closeModal();
                renderCalendar();
                renderEvents();
                toast('Evento eliminado');
            }
        }

        // ===== PDF IMPORT =====
        async function processPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }

                console.log('PDF Text:', fullText); // Debug

                // Parse trainings from text
                const trainings = parseTrainings(fullText);
                
                if (trainings.length === 0) {
                    toast('No se encontr√≥ informaci√≥n del Prebenjam√≠n B');
                    return;
                }

                importedData = trainings;
                let html = '';
                trainings.forEach(t => {
                    const typeLabel = t.type === 'match' ? ' (Partido)' : '';
                    html += '<tr><td>' + t.day + typeLabel + '</td><td>' + t.time + '</td><td>' + (t.field || '‚Äî') + '</td></tr>';
                });
                document.getElementById('previewBody').innerHTML = html;
                document.getElementById('preview').classList.add('show');

            } catch (err) {
                console.error(err);
                toast('Error al procesar el PDF');
            }
        }

        function parseTrainings(text) {
            const trainings = [];
            
            // Normalize whitespace
            const normalized = text.replace(/\s+/g, ' ');
            
            // Find the Prebenjamin B row data
            // The PDF structure has: "Prebenjamin B" followed by data for each day column
            
            // Look for pattern: Prebenjamin B ... (training data) ... Debutante
            const prebMatch = normalized.match(/Prebenjamin\s*B\s+(.*?)(?=Debutante|$)/i);
            
            if (!prebMatch) {
                console.log('No Prebenjamin B section found');
                return trainings;
            }
            
            const section = prebMatch[1];
            console.log('Prebenjamin B section:', section);
            
            // Find all "Entrenamiento Campo X-X Hora: HH:MM" patterns
            const allTrainings = [];
            const trainingRegex = /Entrenamiento\s+Campo\s+(\d+\s*-?\s*[A-Za-z]?)\s+Hora:\s*(\d{1,2}):(\d{2})/gi;
            let match;
            
            while ((match = trainingRegex.exec(section)) !== null) {
                const field = match[1].replace(/\s+/g, '').toUpperCase();
                const time = match[2].padStart(2, '0') + ':' + match[3];
                allTrainings.push({ field, time });
            }
            
            console.log('Found trainings:', allTrainings);
            
            // Based on the PDF structure, Prebenjamin B trains:
            // Column order: Lunes, Martes, Mi√©rcoles, Jueves, Viernes, S√°bado, Domingo
            // From the PDF we can see: Lunes (8-B, 18:45), Martes (8-B, 18:45), Mi√©rcoles (5-B, 18:30)
            
            const dayNames = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
            const dayNums = [1, 2, 3, 4, 5, 6, 0];
            
            // Assign trainings to days in order
            allTrainings.forEach((t, idx) => {
                if (idx < dayNames.length) {
                    trainings.push({
                        day: dayNames[idx],
                        dayNum: dayNums[idx],
                        time: t.time,
                        field: t.field,
                        type: 'training'
                    });
                }
            });
            
            // Also check for match (Jornada)
            const jornadaMatch = section.match(/Jornada\s+\d+\s+(.*?)\s+Campo\s+([\d\w\-]+)\s*\|?\s*Hora:\s*(\d{1,2}):(\d{2})/i);
            if (jornadaMatch) {
                const opponent = jornadaMatch[1].trim();
                const field = jornadaMatch[2].replace(/\s+/g, '').toUpperCase();
                const time = jornadaMatch[3].padStart(2, '0') + ':' + jornadaMatch[4];
                
                // Find which day (usually S√°bado or Domingo based on position)
                trainings.push({
                    day: 'S√°bado',
                    dayNum: 6,
                    time: time,
                    field: field,
                    type: 'match',
                    opponent: opponent
                });
            }
            
            return trainings;
        }

        async function confirmImport() {
            const today = new Date();
            const end = new Date();
            end.setMonth(end.getMonth() + 3);

            let count = 0;
            for (const t of importedData) {
                let d = new Date(today);
                while (d <= end) {
                    if (d.getDay() === t.dayNum) {
                        const dateStr = d.toISOString().split('T')[0];
                        if (!events.some(e => e.date === dateStr && e.type === 'training' && e.time === t.time)) {
                            const newEvent = {
                                id: Date.now().toString(36) + Math.random().toString(36).substr(2) + count,
                                title: 'Entrenamiento',
                                type: 'training',
                                date: dateStr,
                                time: t.time,
                                location: t.field ? 'Campo ' + t.field : '',
                                created_by: currentUser
                            };
                            events.push(newEvent);
                            await saveEvent(newEvent);
                            count++;
                        }
                    }
                    d.setDate(d.getDate() + 1);
                }
            }

            document.getElementById('preview').classList.remove('show');
            document.getElementById('fileInput').value = '';
            importedData = [];
            renderCalendar();
            renderEvents();
            toast('Se a√±adieron ' + count + ' entrenamientos');
        }

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', function() {
            // Check session
            const savedUser = localStorage.getItem('user');
            if (savedUser && USERS[savedUser]) {
                currentUser = savedUser;
                showApp();
            }

            // Login form
            document.getElementById('loginForm').onsubmit = function(e) {
                e.preventDefault();
                const user = document.getElementById('username').value;
                const pass = document.getElementById('password').value;
                if (login(user, pass)) {
                    showApp();
                } else {
                    document.getElementById('loginError').classList.add('show');
                }
            };

            // Logout
            document.getElementById('logoutBtn').onclick = logout;

            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.onclick = function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab + 'Panel').classList.add('active');
                };
            });

            // Calendar nav
            document.getElementById('prevMonth').onclick = function() { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); };
            document.getElementById('nextMonth').onclick = function() { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); };
            document.getElementById('todayBtn').onclick = function() { currentDate = new Date(); renderCalendar(); };

            // Modal
            document.getElementById('addEventBtn').onclick = function() { openModal(); };
            document.getElementById('modalClose').onclick = closeModal;
            document.getElementById('modal').onclick = function(e) { if (e.target === this) closeModal(); };
            document.getElementById('saveBtn').onclick = handleSave;
            document.getElementById('deleteBtn').onclick = handleDelete;

            // File upload
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');
            uploadZone.onclick = function() { fileInput.click(); };
            fileInput.onchange = function() { if (this.files[0]) processPDF(this.files[0]); };
            uploadZone.ondragover = function(e) { e.preventDefault(); this.style.borderColor = '#D4AF37'; };
            uploadZone.ondragleave = function() { this.style.borderColor = '#E8E8E8'; };
            uploadZone.ondrop = function(e) { e.preventDefault(); this.style.borderColor = '#E8E8E8'; if (e.dataTransfer.files[0]) processPDF(e.dataTransfer.files[0]); };

            document.getElementById('cancelImport').onclick = function() { document.getElementById('preview').classList.remove('show'); importedData = []; };
            document.getElementById('confirmImport').onclick = confirmImport;
        });
    </script>
</body>
</html>
