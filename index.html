<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Prebenjam√≠n B | Calendario</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PrebenB">
    <meta name="theme-color" content="#0D0D0D">
    <meta name="description" content="Calendario Prebenjam√≠n B - Real Madrid">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAgMTgwIj48cmVjdCBmaWxsPSIjMEQwRDBEIiB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgcng9IjQwIi8+PHRleHQgeD0iOTAiIHk9IjExNSIgZm9udC1mYW1pbHk9IkFyaWFsIEJsYWNrIiBmb250LXNpemU9IjgwIiBmb250LXdlaWdodD0iYm9sZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iI0ZGRUEwMCI+UEI8L3RleHQ+PC9zdmc+">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAgMTgwIj48cmVjdCBmaWxsPSIjMEQwRDBEIiB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgcng9IjQwIi8+PHRleHQgeD0iOTAiIHk9IjExNSIgZm9udC1mYW1pbHk9IkFyaWFsIEJsYWNrIiBmb250LXNpemU9IjgwIiBmb250LXdlaWdodD0iYm9sZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iI0ZGRUEwMCI+UEI8L3RleHQ+PC9zdmc+">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ2FsZW5kYXJpbyBQcmViZW5qYW3DrW4gQiIsInNob3J0X25hbWUiOiJQcmViZW5CIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwRDBEMEQiLCJ0aGVtZV9jb2xvciI6IiMwRDBEMEQifQ==">
    
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            --white: #FFFFFF;
            --cream: #FAFAFA;
            --gold: #FFEA00;
            --black: #0D0D0D;
            --gray: #888;
            --gray-light: #E8E8E8;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { overflow-x: hidden; width: 100%; }
        body { font-family: 'Inter', sans-serif; background: var(--cream); min-height: 100vh; }

        /* LOGIN */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--white);
        }
        .login-box { padding: 60px 40px; width: 100%; max-width: 360px; text-align: center; }
        .login-logo { width: 80px; height: 96px; margin: 0 auto 32px; }
        .login-logo img { width: 100%; height: 100%; object-fit: contain; }
        .login-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.3rem;
            letter-spacing: 0.3em;
            color: var(--black);
            margin-bottom: 40px;
        }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-input {
            width: 100%;
            padding: 14px 0;
            border: none;
            border-bottom: 1px solid var(--gray-light);
            font-size: 15px;
            background: transparent;
        }
        .form-input:focus { outline: none; border-bottom-color: var(--gold); }
        .login-btn {
            width: 100%;
            padding: 14px;
            background: var(--black);
            color: var(--white);
            border: none;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            letter-spacing: 0.2em;
            cursor: pointer;
            margin-top: 16px;
        }
        .login-error { color: #c00; font-size: 13px; margin-bottom: 16px; display: none; }
        .login-error.show { display: block; }

        /* APP */
        .app { display: none; min-height: 100vh; }
        .app.active { display: flex; flex-direction: column; }

        /* HEADER */
        .header {
            background: var(--black);
            color: var(--white);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .header-logo { width: 28px; height: 34px; }
        .header-logo img { width: 100%; height: 100%; object-fit: contain; }
        .header-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 0.1em; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .header-btn {
            background: transparent;
            border: none;
            color: var(--white);
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .header-btn:hover, .header-btn.active { opacity: 1; }
        .header-btn.notif.active { color: var(--gold); }

        /* MAIN CONTENT */
        .main { flex: 1; display: flex; flex-direction: column; }

        /* TODAY VIEW */
        .today-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px 20px;
        }
        .today-header {
            text-align: center;
            margin-bottom: 24px;
        }
        .today-weekday {
            font-size: 14px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.2em;
            margin-bottom: 8px;
        }
        .today-date {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 4rem;
            line-height: 1;
            color: var(--black);
        }
        .today-month {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            color: var(--gray);
            letter-spacing: 0.1em;
        }
        .today-nav {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 16px;
        }
        .today-nav-btn {
            background: var(--white);
            border: 1px solid var(--gray-light);
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .today-nav-btn:hover { border-color: var(--gold); }
        .today-nav-btn.today-reset {
            width: auto;
            padding: 0 16px;
            font-size: 12px;
            font-weight: 500;
        }

        /* EVENTS TODAY */
        .today-events { flex: 1; }
        .events-title {
            font-size: 12px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 16px;
        }
        .no-events {
            background: var(--white);
            border: 1px solid var(--gray-light);
            padding: 40px 20px;
            text-align: center;
            color: var(--gray);
            font-size: 14px;
        }
        .event-item {
            background: var(--white);
            border: 1px solid var(--gray-light);
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .event-item:hover { border-color: var(--gold); }
        .event-time {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.3rem;
            min-width: 60px;
        }
        .event-details { flex: 1; }
        .event-title { font-weight: 500; font-size: 14px; margin-bottom: 2px; }
        .event-location { font-size: 12px; color: var(--gray); }
        .event-badge {
            font-size: 9px;
            padding: 4px 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .event-badge.training { background: var(--gold); color: var(--black); }
        .event-badge.match { background: var(--black); color: var(--white); }
        .event-badge.meeting { background: var(--gray); color: var(--white); }

        /* FAB - Floating Action Button */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: var(--gold);
            border: none;
            border-radius: 50%;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 100;
            transition: transform 0.2s;
        }
        .fab:hover { transform: scale(1.1); }

        /* BOTTOM NAV */
        .bottom-nav {
            background: var(--white);
            border-top: 1px solid var(--gray-light);
            display: flex;
            padding: 8px 0;
        }
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            background: none;
            border: none;
            color: var(--gray);
            font-size: 10px;
            cursor: pointer;
            transition: color 0.2s;
        }
        .nav-item.active { color: var(--black); }
        .nav-item .icon { font-size: 20px; }

        /* PANELS */
        .panel { display: none; flex: 1; overflow-y: auto; }
        .panel.active { display: flex; flex-direction: column; }

        /* CALENDAR PANEL */
        .calendar-panel { padding: 20px; }
        .calendar-month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .calendar-month {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.3rem;
            letter-spacing: 0.05em;
        }
        .cal-nav-btn {
            background: var(--white);
            border: 1px solid var(--gray-light);
            width: 36px;
            height: 36px;
            font-size: 16px;
            cursor: pointer;
        }
        .mini-calendar {
            background: var(--white);
            border: 1px solid var(--gray-light);
        }
        .mini-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border-bottom: 1px solid var(--gray-light);
        }
        .mini-weekday {
            padding: 12px 4px;
            text-align: center;
            font-size: 10px;
            font-weight: 500;
            color: var(--gray);
        }
        .mini-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        .mini-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            cursor: pointer;
            position: relative;
            border: 1px solid transparent;
        }
        .mini-day:hover { background: var(--cream); }
        .mini-day.other { color: #ccc; }
        .mini-day.today { background: var(--gold); font-weight: 600; }
        .mini-day.selected { border-color: var(--black); }
        .mini-day.has-events::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 4px;
            height: 4px;
            background: var(--black);
            border-radius: 50%;
        }
        .mini-day.today.has-events::after { background: var(--white); }

        /* PLANTILLA PANEL */
        .plantilla-panel { padding: 20px; }
        .plantilla-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 0.1em;
            margin-bottom: 16px;
        }
        .players-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .player-card {
            background: var(--white);
            border: 1px solid var(--gray-light);
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .player-num {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            background: var(--gold);
            color: var(--black);
            padding: 2px 8px;
            min-width: 32px;
            text-align: center;
        }
        .player-info { flex: 1; min-width: 0; }
        .player-name { font-weight: 500; font-size: 13px; }
        .player-bday { font-size: 10px; color: var(--gray); }
        .player-link {
            font-size: 9px;
            color: var(--gray);
            text-decoration: none;
        }

        /* IMPORTAR PANEL */
        .importar-panel { padding: 20px; }
        .importar-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 0.1em;
            margin-bottom: 8px;
        }
        .importar-desc {
            font-size: 13px;
            color: var(--gray);
            margin-bottom: 24px;
        }
        .upload-zone {
            background: var(--white);
            border: 2px dashed var(--gray-light);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .upload-zone:hover { border-color: var(--gold); }
        .upload-zone input { display: none; }
        .upload-icon { font-size: 40px; margin-bottom: 12px; }
        .upload-text { font-weight: 500; margin-bottom: 4px; }
        .upload-hint { font-size: 12px; color: var(--gray); }
        .import-status {
            background: var(--white);
            border: 1px solid var(--gray-light);
            padding: 24px;
            text-align: center;
            margin-top: 16px;
        }
        .status-icon { font-size: 32px; margin-bottom: 8px; }
        .status-text { font-size: 14px; color: var(--gray); }
        .import-preview { margin-top: 24px; }
        .preview-item {
            background: var(--white);
            border: 1px solid var(--gray-light);
            padding: 12px;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .preview-date { font-weight: 600; color: var(--black); }
        .preview-title { color: var(--gray); }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: flex-end;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: var(--white);
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 24px 20px;
            border-radius: 16px 16px 0 0;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .modal-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 0.1em;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }
        .form-field { margin-bottom: 20px; }
        .form-label {
            display: block;
            font-size: 11px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 8px;
        }
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray-light);
            font-size: 14px;
            font-family: inherit;
        }
        .form-control:focus { outline: none; border-color: var(--gold); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn-primary {
            width: 100%;
            padding: 14px;
            background: var(--black);
            color: var(--white);
            border: none;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            letter-spacing: 0.1em;
            cursor: pointer;
        }
        .btn-danger {
            width: 100%;
            padding: 12px;
            background: transparent;
            color: #c00;
            border: 1px solid #c00;
            font-size: 13px;
            cursor: pointer;
            margin-top: 12px;
        }

        /* TOAST */
        .toast-container { position: fixed; bottom: 100px; left: 20px; right: 20px; z-index: 300; }
        .toast {
            background: var(--black);
            color: var(--white);
            padding: 14px 20px;
            margin-bottom: 8px;
            font-size: 13px;
            text-align: center;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* INSTALL BANNER */
        .install-banner {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 16px;
            right: 16px;
            background: var(--black);
            color: var(--white);
            padding: 14px 16px;
            border-radius: 8px;
            z-index: 150;
            align-items: center;
            gap: 12px;
        }
        .install-banner.show { display: flex; }
        .install-banner p { flex: 1; font-size: 12px; margin: 0; }
        .install-banner button {
            background: var(--gold);
            color: var(--black);
            border: none;
            padding: 8px 14px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
        }
        .install-close { background: transparent !important; color: var(--gray) !important; font-size: 16px !important; padding: 4px !important; }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-logo">
                <img src="https://upload.wikimedia.org/wikipedia/en/5/56/Real_Madrid_CF.svg" alt="Real Madrid">
            </div>
            <h1 class="login-title">PREBENJAM√çN B</h1>
            <div class="login-error" id="loginError">Usuario o contrase√±a incorrectos</div>
            <form id="loginForm">
                <div class="form-group">
                    <input type="text" class="form-input" id="username" placeholder="Usuario" required>
                </div>
                <div class="form-group">
                    <input type="password" class="form-input" id="password" placeholder="Contrase√±a" required>
                </div>
                <button type="submit" class="login-btn">ACCEDER</button>
            </form>
        </div>
    </div>

    <!-- APP -->
    <div class="app" id="app">
        <header class="header">
            <div class="header-left">
                <div class="header-logo">
                    <img src="https://upload.wikimedia.org/wikipedia/en/5/56/Real_Madrid_CF.svg" alt="RM">
                </div>
                <span class="header-title">PREBENJAM√çN B</span>
            </div>
            <div class="header-right">
                <button class="header-btn notif" id="notifBtn" title="Notificaciones">üîî</button>
                <button class="header-btn" id="logoutBtn" title="Cerrar sesi√≥n">‚èª</button>
            </div>
        </header>

        <main class="main">
            <!-- HOY Panel -->
            <div class="panel active" id="hoyPanel">
                <div class="today-view">
                    <div class="today-header">
                        <div class="today-weekday" id="todayWeekday"></div>
                        <div class="today-date" id="todayDate"></div>
                        <div class="today-month" id="todayMonth"></div>
                        <div class="today-nav">
                            <button class="today-nav-btn" id="prevDay">‚Äπ</button>
                            <button class="today-nav-btn today-reset" id="goToday">HOY</button>
                            <button class="today-nav-btn" id="nextDay">‚Ä∫</button>
                        </div>
                    </div>
                    <div class="today-events">
                        <div class="events-title">EVENTOS DEL D√çA</div>
                        <div id="dayEventsList"></div>
                    </div>
                </div>
            </div>

            <!-- CALENDARIO Panel -->
            <div class="panel" id="calendarioPanel">
                <div class="calendar-panel">
                    <div class="calendar-month-nav">
                        <button class="cal-nav-btn" id="calPrev">‚Äπ</button>
                        <span class="calendar-month" id="calMonth"></span>
                        <button class="cal-nav-btn" id="calNext">‚Ä∫</button>
                    </div>
                    <div class="mini-calendar">
                        <div class="mini-weekdays">
                            <div class="mini-weekday">L</div>
                            <div class="mini-weekday">M</div>
                            <div class="mini-weekday">X</div>
                            <div class="mini-weekday">J</div>
                            <div class="mini-weekday">V</div>
                            <div class="mini-weekday">S</div>
                            <div class="mini-weekday">D</div>
                        </div>
                        <div class="mini-days" id="calDays"></div>
                    </div>
                    <div style="margin-top: 24px;">
                        <div class="events-title">PR√ìXIMOS EVENTOS</div>
                        <div id="upcomingEvents"></div>
                    </div>
                </div>
            </div>

            <!-- PLANTILLA Panel -->
            <div class="panel" id="plantillaPanel">
                <div class="plantilla-panel">
                    <div class="plantilla-title">PLANTILLA 2025-26</div>
                    <div class="players-grid" id="playersGrid"></div>
                </div>
            </div>

            <!-- IMPORTAR Panel -->
            <div class="panel" id="importarPanel">
                <div class="importar-panel">
                    <div class="importar-title">IMPORTAR CALENDARIO</div>
                    <p class="importar-desc">Sube el PDF del calendario mensual para importar todos los eventos autom√°ticamente.</p>
                    
                    <div class="upload-zone" id="uploadZone">
                        <input type="file" id="pdfInput" accept=".pdf">
                        <div class="upload-icon">üìÑ</div>
                        <div class="upload-text">Pulsa para subir PDF</div>
                        <div class="upload-hint">Formato: Calendario mensual del equipo</div>
                    </div>

                    <div class="import-status" id="importStatus" style="display:none;">
                        <div class="status-icon">‚è≥</div>
                        <div class="status-text">Procesando...</div>
                    </div>

                    <div class="import-preview" id="importPreview" style="display:none;">
                        <div class="events-title">EVENTOS ENCONTRADOS</div>
                        <div id="previewList"></div>
                        <button class="btn-primary" id="confirmImport" style="margin-top:16px;">IMPORTAR TODOS</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" data-panel="hoy">
                <span class="icon">üìÖ</span>
                <span>Hoy</span>
            </button>
            <button class="nav-item" data-panel="calendario">
                <span class="icon">üóìÔ∏è</span>
                <span>Mes</span>
            </button>
            <button class="nav-item" data-panel="importar">
                <span class="icon">üì§</span>
                <span>Importar</span>
            </button>
            <button class="nav-item" data-panel="plantilla">
                <span class="icon">üë•</span>
                <span>Equipo</span>
            </button>
        </nav>

        <!-- FAB -->
        <button class="fab" id="fabAdd">+</button>

        <!-- Install Banner -->
        <div class="install-banner" id="installBanner">
            <p>üì± Instala la app en tu m√≥vil</p>
            <button id="installBtn">INSTALAR</button>
            <button class="install-close" id="installClose">‚úï</button>
        </div>
    </div>

    <!-- MODAL -->
    <div class="modal" id="eventModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">NUEVO EVENTO</span>
                <button class="modal-close" id="modalClose">√ó</button>
            </div>
            <div class="form-field">
                <label class="form-label">T√≠tulo</label>
                <input type="text" class="form-control" id="eventTitle" placeholder="Nombre del evento">
            </div>
            <div class="form-field">
                <label class="form-label">Tipo</label>
                <select class="form-control" id="eventType">
                    <option value="training">Entrenamiento</option>
                    <option value="match">Partido</option>
                    <option value="meeting">Reuni√≥n / Otro</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-field">
                    <label class="form-label">Fecha</label>
                    <input type="date" class="form-control" id="eventDate">
                </div>
                <div class="form-field">
                    <label class="form-label">Hora</label>
                    <input type="time" class="form-control" id="eventTime" value="17:00">
                </div>
            </div>
            <div class="form-field">
                <label class="form-label">Lugar</label>
                <input type="text" class="form-control" id="eventLocation" placeholder="Campo, direcci√≥n...">
            </div>
            <button class="btn-primary" id="saveEvent">GUARDAR</button>
            <button class="btn-danger" id="deleteEvent" style="display:none;">Eliminar evento</button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toasts"></div>

    <script>
        // ===== CONFIG =====
        const SUPABASE_URL = 'https://bxawlznatchqdvpdrjuh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4YXdsem5hdGNocWR2cGRyanVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4MzQ4NjMsImV4cCI6MjA1MzQxMDg2M30.601s6L_02hBf4L3YKV--_qP_qWjKPHOganMsT4v7J0M';
        
        const USERS = {
            'raul': { password: 'preb2026', name: 'Ra√∫l' },
            'sergio': { password: 'preb2026', name: 'Sergio' }
        };

        const WEEKDAYS = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
        const MONTHS = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        const PLAYERS = [
            { num: '1', name: 'Jaime', bday: '8 abr', url: 'jaime-crespo-larraz' },
            { num: '2', name: 'Dani', bday: '28 ene', url: 'daniel-rodriguez-perez' },
            { num: '3', name: 'El√≠as', bday: '23 mar', url: 'elias-pena-gonzalez' },
            { num: '4', name: 'Garc√≠a', bday: '25 ago', url: 'pablo-garcia-martorell' },
            { num: '5', name: 'Mateo', bday: '8 mar', url: 'mateo-praja' },
            { num: '6', name: 'Jorge', bday: '23 ene', url: 'jorge-perez-santiago' },
            { num: '7', name: 'Medina', bday: '3 mar', url: 'marco-medina-gutierrez' },
            { num: '8', name: 'Montoya', bday: '6 jun', url: 'daniel-montoya-bajo' },
            { num: '9', name: 'Hugo', bday: '11 feb', url: 'hugo-terron-nunez' },
            { num: '10', name: 'Mauro', bday: '1 ene', url: 'mauro-urrutia-de-francisco' },
            { num: '11', name: 'Alberto', bday: '16 may', url: 'alberto-gomez-de-benito' },
            { num: '12', name: 'Enzo', bday: '16 feb', url: 'enzo-guijosa-moreno' },
            { num: '13', name: 'Bruno', bday: '13 jul', url: 'bruno-jimenez-gomez' },
            { num: '13B', name: 'Marcos', bday: '18 may', url: 'marcos-blasco-donoso' },
            { num: '14', name: 'Mart√≠n', bday: '9 ene', url: 'pablo-martin-teresa' },
            { num: '15', name: 'V√≠ctor', bday: '17 ene', url: 'victor-rosado-martin' }
        ];

        const BIRTHDAYS = [
            { name: 'Jaime', day: 8, month: 4 },
            { name: 'Dani', day: 28, month: 1 },
            { name: 'El√≠as', day: 23, month: 3 },
            { name: 'Garc√≠a', day: 25, month: 8 },
            { name: 'Mateo', day: 8, month: 3 },
            { name: 'Jorge', day: 23, month: 1 },
            { name: 'Medina', day: 3, month: 3 },
            { name: 'Montoya', day: 6, month: 6 },
            { name: 'Hugo', day: 11, month: 2 },
            { name: 'Mauro', day: 1, month: 1 },
            { name: 'Alberto', day: 16, month: 5 },
            { name: 'Enzo', day: 16, month: 2 },
            { name: 'Bruno', day: 13, month: 7 },
            { name: 'Marcos', day: 18, month: 5 },
            { name: 'Mart√≠n', day: 9, month: 1 },
            { name: 'V√≠ctor', day: 17, month: 1 }
        ];

        // ===== STATE =====
        let currentUser = null;
        let events = [];
        let selectedDate = new Date();
        let calendarDate = new Date();
        let editingId = null;
        let notificationsEnabled = false;

        // ===== SUPABASE =====
        async function loadEvents() {
            try {
                const res = await fetch(`${SUPABASE_URL}/rest/v1/events?select=*`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                events = await res.json();
            } catch (e) {
                console.log('Error loading events:', e);
                events = JSON.parse(localStorage.getItem('events') || '[]');
            }
        }

        async function saveEvent(event) {
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/events`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify(event)
                });
            } catch (e) {
                console.log('Error saving:', e);
            }
            localStorage.setItem('events', JSON.stringify(events));
        }

        async function updateEvent(id, data) {
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/events?id=eq.${id}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
            } catch (e) {
                console.log('Error updating:', e);
            }
            localStorage.setItem('events', JSON.stringify(events));
        }

        async function deleteEvent(id) {
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/events?id=eq.${id}`, {
                    method: 'DELETE',
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
            } catch (e) {
                console.log('Error deleting:', e);
            }
            localStorage.setItem('events', JSON.stringify(events));
        }

        // ===== AUTH =====
        function login(user, pass) {
            if (USERS[user] && USERS[user].password === pass) {
                currentUser = user;
                localStorage.setItem('user', user);
                return true;
            }
            return false;
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('user');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('app').classList.remove('active');
        }

        async function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').classList.add('active');
            await loadEvents();
            await initBirthdays();
            renderTodayView();
            renderCalendar();
            renderPlantilla();
            initNotifications();
        }

        // ===== TOAST =====
        function toast(msg) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.textContent = msg;
            document.getElementById('toasts').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // ===== TODAY VIEW =====
        function renderTodayView() {
            const dateStr = selectedDate.toISOString().split('T')[0];
            const dayNum = selectedDate.getDate();
            const weekday = WEEKDAYS[selectedDate.getDay()];
            const month = MONTHS[selectedDate.getMonth()];
            const year = selectedDate.getFullYear();

            document.getElementById('todayWeekday').textContent = weekday;
            document.getElementById('todayDate').textContent = dayNum;
            document.getElementById('todayMonth').textContent = `${month} ${year}`;

            // Events for this day
            const dayEvents = events.filter(e => e.date === dateStr).sort((a, b) => (a.time || '').localeCompare(b.time || ''));
            
            if (dayEvents.length === 0) {
                document.getElementById('dayEventsList').innerHTML = '<div class="no-events">No hay eventos este d√≠a</div>';
            } else {
                let html = '';
                dayEvents.forEach(e => {
                    const typeLabel = e.type === 'training' ? 'Entreno' : e.type === 'match' ? 'Partido' : 'Evento';
                    html += `
                        <div class="event-item" data-id="${e.id}">
                            <div class="event-time">${e.time || '--:--'}</div>
                            <div class="event-details">
                                <div class="event-title">${e.title}</div>
                                <div class="event-location">${e.location || ''}</div>
                            </div>
                            <span class="event-badge ${e.type}">${typeLabel}</span>
                        </div>
                    `;
                });
                document.getElementById('dayEventsList').innerHTML = html;

                // Click to edit
                document.querySelectorAll('.event-item').forEach(item => {
                    item.onclick = () => openModal(item.dataset.id);
                });
            }
        }

        // ===== CALENDAR =====
        function renderCalendar() {
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            document.getElementById('calMonth').textContent = `${MONTHS[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = (firstDay.getDay() + 6) % 7; // Monday = 0
            const totalDays = lastDay.getDate();
            const today = new Date().toISOString().split('T')[0];
            const selected = selectedDate.toISOString().split('T')[0];

            let html = '';
            
            // Previous month days
            const prevMonth = new Date(year, month, 0);
            for (let i = startDay - 1; i >= 0; i--) {
                const d = prevMonth.getDate() - i;
                html += `<div class="mini-day other">${d}</div>`;
            }

            // Current month days
            for (let d = 1; d <= totalDays; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const isToday = dateStr === today;
                const isSelected = dateStr === selected;
                const hasEvents = events.some(e => e.date === dateStr);
                
                let classes = 'mini-day';
                if (isToday) classes += ' today';
                if (isSelected) classes += ' selected';
                if (hasEvents) classes += ' has-events';
                
                html += `<div class="${classes}" data-date="${dateStr}">${d}</div>`;
            }

            // Next month days
            const remaining = 42 - (startDay + totalDays);
            for (let d = 1; d <= remaining; d++) {
                html += `<div class="mini-day other">${d}</div>`;
            }

            document.getElementById('calDays').innerHTML = html;

            // Click on day
            document.querySelectorAll('.mini-day:not(.other)').forEach(day => {
                day.onclick = () => {
                    selectedDate = new Date(day.dataset.date);
                    renderTodayView();
                    renderCalendar();
                    // Switch to today panel
                    switchPanel('hoy');
                };
            });

            // Render upcoming events
            renderUpcomingEvents();
        }

        function renderUpcomingEvents() {
            const today = new Date().toISOString().split('T')[0];
            const upcoming = events.filter(e => e.date >= today).sort((a, b) => a.date.localeCompare(b.date)).slice(0, 5);
            
            if (upcoming.length === 0) {
                document.getElementById('upcomingEvents').innerHTML = '<div class="no-events">No hay eventos pr√≥ximos</div>';
                return;
            }

            let html = '';
            upcoming.forEach(e => {
                const [y, m, d] = e.date.split('-');
                const typeLabel = e.type === 'training' ? 'Entreno' : e.type === 'match' ? 'Partido' : 'Evento';
                html += `
                    <div class="event-item" data-id="${e.id}">
                        <div class="event-time" style="font-size:1rem;">${parseInt(d)}<br><span style="font-size:10px;color:var(--gray)">${MONTHS[parseInt(m)-1].slice(0,3)}</span></div>
                        <div class="event-details">
                            <div class="event-title">${e.title}</div>
                            <div class="event-location">${e.time || ''} ${e.location ? '¬∑ ' + e.location : ''}</div>
                        </div>
                        <span class="event-badge ${e.type}">${typeLabel}</span>
                    </div>
                `;
            });
            document.getElementById('upcomingEvents').innerHTML = html;

            document.querySelectorAll('#upcomingEvents .event-item').forEach(item => {
                item.onclick = () => openModal(item.dataset.id);
            });
        }

        // ===== PLANTILLA =====
        function renderPlantilla() {
            let html = '';
            PLAYERS.forEach(p => {
                html += `
                    <div class="player-card">
                        <span class="player-num">${p.num}</span>
                        <div class="player-info">
                            <div class="player-name">${p.name}</div>
                            <div class="player-bday">üéÇ ${p.bday}</div>
                            <a class="player-link" href="https://www.realmadrid.com/es-ES/futbol/cantera-masculina/prebenjamin-b/${p.url}" target="_blank">Ver ficha</a>
                        </div>
                    </div>
                `;
            });
            document.getElementById('playersGrid').innerHTML = html;
        }

        // ===== MODAL =====
        function openModal(id = null) {
            editingId = id;
            const modal = document.getElementById('eventModal');
            
            if (id) {
                const e = events.find(x => x.id === id);
                document.getElementById('modalTitle').textContent = 'EDITAR EVENTO';
                document.getElementById('eventTitle').value = e.title;
                document.getElementById('eventType').value = e.type;
                document.getElementById('eventDate').value = e.date;
                document.getElementById('eventTime').value = e.time || '';
                document.getElementById('eventLocation').value = e.location || '';
                document.getElementById('deleteEvent').style.display = 'block';
            } else {
                document.getElementById('modalTitle').textContent = 'NUEVO EVENTO';
                document.getElementById('eventTitle').value = '';
                document.getElementById('eventType').value = 'training';
                document.getElementById('eventDate').value = selectedDate.toISOString().split('T')[0];
                document.getElementById('eventTime').value = '17:00';
                document.getElementById('eventLocation').value = '';
                document.getElementById('deleteEvent').style.display = 'none';
            }
            
            modal.classList.add('show');
        }

        function closeModal() {
            document.getElementById('eventModal').classList.remove('show');
            editingId = null;
        }

        async function handleSave() {
            const title = document.getElementById('eventTitle').value.trim();
            const type = document.getElementById('eventType').value;
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const location = document.getElementById('eventLocation').value.trim();

            if (!title || !date) {
                toast('Completa t√≠tulo y fecha');
                return;
            }

            if (editingId) {
                const idx = events.findIndex(e => e.id === editingId);
                events[idx] = { ...events[idx], title, type, date, time, location };
                await updateEvent(editingId, { title, type, date, time, location });
                toast('Evento actualizado');
            } else {
                const newEvent = {
                    id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                    title, type, date, time, location,
                    created_by: currentUser
                };
                events.push(newEvent);
                await saveEvent(newEvent);
                toast('Evento creado');
            }

            closeModal();
            renderTodayView();
            renderCalendar();
        }

        async function handleDelete() {
            if (!editingId) return;
            events = events.filter(e => e.id !== editingId);
            await deleteEvent(editingId);
            toast('Evento eliminado');
            closeModal();
            renderTodayView();
            renderCalendar();
        }

        // ===== NAVIGATION =====
        function switchPanel(panelName) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(panelName + 'Panel').classList.add('active');
            document.querySelector(`.nav-item[data-panel="${panelName}"]`).classList.add('active');
        }

        // ===== BIRTHDAYS =====
        async function initBirthdays() {
            const key = 'birthdaysAdded2026';
            if (localStorage.getItem(key)) return;

            let count = 0;
            for (const b of BIRTHDAYS) {
                const dateStr = `2026-${String(b.month).padStart(2, '0')}-${String(b.day).padStart(2, '0')}`;
                const title = `üéÇ Cumple ${b.name}`;
                if (!events.some(e => e.date === dateStr && e.title === title)) {
                    const newEvent = {
                        id: 'bday_' + b.name.toLowerCase(),
                        title, type: 'meeting', date: dateStr,
                        time: null, location: null,
                        created_by: 'system'
                    };
                    events.push(newEvent);
                    await saveEvent(newEvent);
                    count++;
                }
            }
            localStorage.setItem(key, 'true');
            if (count > 0) toast(`${count} cumplea√±os a√±adidos`);
        }

        // ===== NOTIFICATIONS =====
        async function initNotifications() {
            if (!('Notification' in window)) return;
            
            if (Notification.permission === 'granted') {
                notificationsEnabled = true;
                document.getElementById('notifBtn').classList.add('active');
                scheduleNotification();
            }
        }

        async function requestNotifications() {
            if (!('Notification' in window)) {
                toast('Tu navegador no soporta notificaciones');
                return;
            }

            if (Notification.permission === 'denied') {
                toast('Notificaciones bloqueadas. Act√≠valas en ajustes del navegador.');
                return;
            }

            const permission = await Notification.requestPermission();
            notificationsEnabled = permission === 'granted';
            
            if (notificationsEnabled) {
                document.getElementById('notifBtn').classList.add('active');
                toast('‚úì Notificaciones activadas. Recibir√°s avisos a las 9:00');
                scheduleNotification();
                // Show test notification
                showNotification('Prebenjam√≠n B', 'Notificaciones activadas correctamente');
            } else {
                toast('Notificaciones no permitidas');
            }
        }

        function scheduleNotification() {
            // Calculate ms until next 9:00
            const now = new Date();
            let next9am = new Date(now);
            next9am.setHours(9, 0, 0, 0);
            
            // If it's past 9am today, schedule for tomorrow
            if (now >= next9am) {
                next9am.setDate(next9am.getDate() + 1);
            }
            
            const msUntil9am = next9am - now;
            console.log('Next notification in:', Math.round(msUntil9am / 1000 / 60), 'minutes');

            setTimeout(() => {
                checkAndNotify();
                // Then repeat every 24 hours
                setInterval(checkAndNotify, 24 * 60 * 60 * 1000);
            }, msUntil9am);
        }

        function checkAndNotify() {
            if (!notificationsEnabled) return;
            
            const today = new Date().toISOString().split('T')[0];
            const todayEvents = events.filter(e => e.date === today);
            
            if (todayEvents.length > 0) {
                const summary = todayEvents.map(e => `${e.time || ''} ${e.title}`).join('\n');
                showNotification(`üìÖ Hoy: ${todayEvents.length} evento(s)`, summary);
            }
        }

        function showNotification(title, body) {
            if (!notificationsEnabled) return;
            
            try {
                new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAgMTgwIj48cmVjdCBmaWxsPSIjMEQwRDBEIiB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgcng9IjQwIi8+PHRleHQgeD0iOTAiIHk9IjExNSIgZm9udC1mYW1pbHk9IkFyaWFsIEJsYWNrIiBmb250LXNpemU9IjgwIiBmb250LXdlaWdodD0iYm9sZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iI0ZGRUEwMCI+UEI8L3RleHQ+PC9zdmc+',
                    badge: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA5NiA5NiI+PHJlY3QgZmlsbD0iI0ZGRUE5MCIgd2lkdGg9Ijk2IiBoZWlnaHQ9Ijk2IiByeD0iMjAiLz48dGV4dCB4PSI0OCIgeT0iNjUiIGZvbnQtZmFtaWx5PSJBcmlhbCBCbGFjayIgZm9udC1zaXplPSI0NSIgZm9udC13ZWlnaHQ9ImJvbGQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiMwRDBEMEQiPlBCPC90ZXh0Pjwvc3ZnPg==',
                    tag: 'prebenjamin-daily',
                    renotify: true
                });
            } catch (e) {
                console.log('Notification error:', e);
            }
        }

        // ===== PDF IMPORT =====
        let pendingImport = [];

        async function processPDF(file) {
            document.getElementById('uploadZone').style.display = 'none';
            document.getElementById('importStatus').style.display = 'block';
            document.getElementById('importPreview').style.display = 'none';

            try {
                const arrayBuffer = await file.arrayBuffer();
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                let allText = [];
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    content.items.forEach(item => {
                        allText.push({
                            text: item.str,
                            x: item.transform[4],
                            y: item.transform[5]
                        });
                    });
                }

                pendingImport = parsePDFEvents(allText);
                
                document.getElementById('importStatus').style.display = 'none';
                
                if (pendingImport.length > 0) {
                    renderPreview();
                    document.getElementById('importPreview').style.display = 'block';
                } else {
                    toast('No se encontraron eventos en el PDF');
                    resetUpload();
                }
            } catch (e) {
                console.error('Error procesando PDF:', e);
                toast('Error al procesar el PDF');
                resetUpload();
            }
        }

        function parsePDFEvents(textItems) {
            const events = [];
            
            // Sort by Y (top to bottom), then X (left to right)
            textItems.sort((a, b) => {
                const yDiff = b.y - a.y;
                if (Math.abs(yDiff) > 5) return yDiff;
                return a.x - b.x;
            });

            // Detectar mes y a√±o del PDF
            let pdfMonth = null;
            let pdfYear = 2026;
            const monthNames = {
                'enero': 1, 'febrero': 2, 'marzo': 3, 'abril': 4,
                'mayo': 5, 'junio': 6, 'julio': 7, 'agosto': 8,
                'septiembre': 9, 'octubre': 10, 'noviembre': 11, 'diciembre': 12
            };

            for (const item of textItems) {
                const text = item.text.toLowerCase();
                for (const [name, num] of Object.entries(monthNames)) {
                    if (text.includes(name)) {
                        pdfMonth = num;
                        const yearMatch = text.match(/20\d{2}/);
                        if (yearMatch) pdfYear = parseInt(yearMatch[0]);
                        break;
                    }
                }
                if (pdfMonth) break;
            }

            if (!pdfMonth) {
                pdfMonth = new Date().getMonth() + 1;
            }

            // Buscar patrones de eventos
            // Patr√≥n: n√∫mero de d√≠a seguido de texto de evento
            const dayPattern = /^(\d{1,2})$/;
            const timePattern = /(\d{1,2})[:\.](\d{2})/;
            
            let currentDay = null;
            let currentText = [];
            
            for (let i = 0; i < textItems.length; i++) {
                const item = textItems[i];
                const text = item.text.trim();
                
                // Si es un n√∫mero de d√≠a (1-31)
                const dayMatch = text.match(dayPattern);
                if (dayMatch && parseInt(dayMatch[1]) >= 1 && parseInt(dayMatch[1]) <= 31) {
                    // Guardar evento anterior si existe
                    if (currentDay && currentText.length > 0) {
                        const eventData = parseEventText(currentText.join(' '), currentDay, pdfMonth, pdfYear);
                        if (eventData) events.push(eventData);
                    }
                    currentDay = parseInt(dayMatch[1]);
                    currentText = [];
                } else if (currentDay && text.length > 1) {
                    // Filtrar textos no relevantes
                    const lower = text.toLowerCase();
                    if (!['lun', 'mar', 'mi√©', 'jue', 'vie', 's√°b', 'dom', 'l', 'm', 'x', 'j', 'v', 's', 'd'].includes(lower) &&
                        !Object.keys(monthNames).some(m => lower.includes(m))) {
                        currentText.push(text);
                    }
                }
            }
            
            // √öltimo evento
            if (currentDay && currentText.length > 0) {
                const eventData = parseEventText(currentText.join(' '), currentDay, pdfMonth, pdfYear);
                if (eventData) events.push(eventData);
            }

            return events;
        }

        function parseEventText(text, day, month, year) {
            if (!text || text.length < 3) return null;
            
            // Extraer hora si existe
            let time = null;
            const timeMatch = text.match(/(\d{1,2})[:\.](\d{2})/);
            if (timeMatch) {
                time = `${timeMatch[1].padStart(2, '0')}:${timeMatch[2]}`;
                text = text.replace(timeMatch[0], '').trim();
            }

            // Detectar tipo
            let type = 'meeting';
            const lower = text.toLowerCase();
            if (lower.includes('entrena') || lower.includes('training')) {
                type = 'training';
                if (!text || lower === 'entrenamiento') text = 'Entrenamiento';
            } else if (lower.includes('partido') || lower.includes('vs') || lower.includes('c.d.') || lower.includes('f.c.') || lower.includes('u.d.')) {
                type = 'match';
            }

            // Limpiar t√≠tulo
            let title = text.replace(/\s+/g, ' ').trim();
            if (title.length < 2) return null;

            // Capitalizar primera letra
            title = title.charAt(0).toUpperCase() + title.slice(1);

            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

            return { title, type, date: dateStr, time, location: null };
        }

        function renderPreview() {
            let html = '';
            pendingImport.forEach((e, idx) => {
                const [y, m, d] = e.date.split('-');
                const typeLabel = e.type === 'training' ? 'üèÉ Entreno' : e.type === 'match' ? '‚öΩ Partido' : 'üìå Evento';
                html += `
                    <div class="preview-item">
                        <span class="preview-date">${parseInt(d)}/${m}</span>
                        ${e.time ? `<span style="color:var(--gray);"> ${e.time}</span>` : ''}
                        <span class="preview-title"> - ${e.title}</span>
                        <span style="float:right;font-size:11px;">${typeLabel}</span>
                    </div>
                `;
            });
            document.getElementById('previewList').innerHTML = html;
        }

        async function confirmImport() {
            let count = 0;
            for (const e of pendingImport) {
                // Evitar duplicados
                const exists = events.some(ex => ex.date === e.date && ex.title === e.title);
                if (!exists) {
                    const newEvent = {
                        id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                        ...e,
                        created_by: currentUser
                    };
                    events.push(newEvent);
                    await saveEvent(newEvent);
                    count++;
                }
            }
            
            toast(`${count} eventos importados`);
            pendingImport = [];
            resetUpload();
            renderTodayView();
            renderCalendar();
            switchPanel('hoy');
        }

        function resetUpload() {
            document.getElementById('uploadZone').style.display = 'block';
            document.getElementById('importStatus').style.display = 'none';
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('pdfInput').value = '';
        }

        // ===== PWA INSTALL =====
        let deferredPrompt = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            setTimeout(() => {
                document.getElementById('installBanner').classList.add('show');
            }, 3000);
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choice) => {
                    if (choice.outcome === 'accepted') {
                        toast('¬°App instalada!');
                    }
                    deferredPrompt = null;
                    document.getElementById('installBanner').classList.remove('show');
                });
            }
        }

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', function() {
            // Check session
            const savedUser = localStorage.getItem('user');
            if (savedUser && USERS[savedUser]) {
                currentUser = savedUser;
                showApp();
            }

            // Login
            document.getElementById('loginForm').onsubmit = function(e) {
                e.preventDefault();
                const user = document.getElementById('username').value;
                const pass = document.getElementById('password').value;
                if (login(user, pass)) {
                    showApp();
                } else {
                    document.getElementById('loginError').classList.add('show');
                }
            };

            // Logout
            document.getElementById('logoutBtn').onclick = logout;

            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.onclick = () => switchPanel(item.dataset.panel);
            });

            // Today navigation
            document.getElementById('prevDay').onclick = () => {
                selectedDate.setDate(selectedDate.getDate() - 1);
                renderTodayView();
                renderCalendar();
            };
            document.getElementById('nextDay').onclick = () => {
                selectedDate.setDate(selectedDate.getDate() + 1);
                renderTodayView();
                renderCalendar();
            };
            document.getElementById('goToday').onclick = () => {
                selectedDate = new Date();
                renderTodayView();
                renderCalendar();
            };

            // Calendar navigation
            document.getElementById('calPrev').onclick = () => {
                calendarDate.setMonth(calendarDate.getMonth() - 1);
                renderCalendar();
            };
            document.getElementById('calNext').onclick = () => {
                calendarDate.setMonth(calendarDate.getMonth() + 1);
                renderCalendar();
            };

            // FAB
            document.getElementById('fabAdd').onclick = () => openModal();

            // Modal
            document.getElementById('modalClose').onclick = closeModal;
            document.getElementById('eventModal').onclick = (e) => {
                if (e.target.id === 'eventModal') closeModal();
            };
            document.getElementById('saveEvent').onclick = handleSave;
            document.getElementById('deleteEvent').onclick = handleDelete;

            // Notifications
            document.getElementById('notifBtn').onclick = requestNotifications;

            // PDF Import
            document.getElementById('uploadZone').onclick = () => {
                document.getElementById('pdfInput').click();
            };
            document.getElementById('pdfInput').onchange = (e) => {
                if (e.target.files[0]) {
                    processPDF(e.target.files[0]);
                }
            };
            document.getElementById('confirmImport').onclick = confirmImport;

            // Install
            document.getElementById('installBtn').onclick = installPWA;
            document.getElementById('installClose').onclick = () => {
                document.getElementById('installBanner').classList.remove('show');
            };

            // iOS install hint
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent) && !window.navigator.standalone) {
                setTimeout(() => {
                    const banner = document.getElementById('installBanner');
                    banner.querySelector('p').textContent = 'üì± Pulsa üì§ y "A√±adir a inicio"';
                    banner.querySelector('#installBtn').style.display = 'none';
                    banner.classList.add('show');
                }, 5000);
            }
        });

        // Register SW for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgKCkgPT4gc2VsZi5za2lwV2FpdGluZygpKTsKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdhY3RpdmF0ZScsICgpID0+IHNlbGYuY2xpZW50cy5jbGFpbSgpKTs=')
                .catch(() => console.log('SW inline not supported'));
        }
    </script>
</body>
</html>
